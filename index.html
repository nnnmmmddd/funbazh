<!DOCTYPE html>
<html lang="fa" dir="rtl" class="dark font-vazir">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ§Ù† Ø¨Ø§Ø² | Ø¨Ø²Ø±Ú¯ØªØ±ÛŒÙ† Ø³Ø§ÛŒØª Ø³Ø±Ú¯Ø±Ù…ÛŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary-indigo': '#4f46e5',
                        'primary-pink': '#ec4899',
                        'primary-purple': '#8b5cf6',
                        'coin-gold': '#f59e0b', // Ø±Ù†Ú¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø§Ù…ØªÛŒØ§Ø²
                        'rank-gold': '#ffd700',
                        'rank-silver': '#c0c0c0',
                        'rank-bronze': '#cd7f32',
                    },
                    fontFamily: {
                        vazir: ['Vazir', 'sans-serif'], 
                    },
                    animation: {
                        shake: 'shake 0.82s cubic-bezier(.36,.07,.19,.97) both',
                        float: 'float 3s ease-in-out infinite',
                        confetti: 'confetti 1.5s ease-out',
                        pulse: 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } },
                        float: { '0%': { transform: 'translateY(0px)' }, '50%': { transform: 'translateY(-10px)' }, '100%': { transform: 'translateY(0px)' } },
                        confetti: { '0%': { transform: 'translateY(0) rotate(0deg)', opacity: 1 }, '100%': { transform: 'translateY(-1000px) rotate(720deg)', opacity: 0 } }
                    }
                }
            }
        }
    </script>
    <style>
        /* CSS Ø¹Ù…ÙˆÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Glassmorphism Ùˆ RTL */
        @font-face {
            font-family: 'Vazir';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.0.3/Vazirmatn-Regular.woff2') format('woff2');
            font-weight: 400;
        }
        .glassmorphism {
            background-color: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        body {
            background: linear-gradient(135deg, #1f2937, #111827); 
            transition: background-color 0.5s;
        }
        .dark body { background: linear-gradient(135deg, #1f2937, #111827); }
        .light body { background: linear-gradient(135deg, #e5e7eb, #f9fafb); color: #1f2937; }
        .light .glassmorphism { background-color: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); }
        main { min-height: calc(100vh - 80px); }
        .page-transition { transition: opacity 0.3s ease-in-out; }
        .riddle-choice:hover { transform: scale(1.02); }

        /* Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ø±Ù†Ú¯ÛŒ Ø«Ø§Ø¨Øª Ø¨Ø±Ø§ÛŒ QuickLinks */
        .link-riddles { background: linear-gradient(to right, #4c1d95, #a855f7); }
        .link-tests { background: linear-gradient(to right, #9d174d, #ec4899); }
        .link-daily { background: linear-gradient(to right, #047857, #34d399); }
        .link-shop { background: linear-gradient(to right, #b45309, #f59e0b); }

        /* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ Ø¨ÙˆØ¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡Ø¯Ø± Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        @media (max-width: 767px) {
            #main-nav {
                display: none !important;
            }
            /* Ø¨Ù‡ÛŒÙ†Ù‡ Ø³Ø§Ø²ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
            #score-display {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.75rem; 
            }
            #current-score {
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body class="font-vazir text-white">

    <header class="sticky top-0 z-50 glassmorphism p-4 border-b border-white/20">
        <div class="container mx-auto flex justify-between items-center">
             <a href="#dashboard" onclick="route('dashboard')" class="text-2xl md:text-3xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-primary-purple">
                FunBaz ğŸ”¥
            </a>
            
             <nav id="main-nav" class="space-x-4 space-x-reverse hidden md:flex font-bold text-sm">
                </nav>
            
            <div class="flex items-center space-x-3 space-x-reverse">
                <div id="score-display" class="hidden md:flex items-center glassmorphism p-2 rounded-full px-4 text-sm font-bold">
                    <span class="text-coin-gold text-xl ml-1">ğŸ’°</span>
                    <span id="current-score">0</span>
                </div>
                
                 <button id="theme-toggle" onclick="toggleTheme()" class="p-2 rounded-full transition duration-300 text-xl hover:bg-white/10">
                    â˜€ï¸
                </button>
                
                 <button id="auth-button" onclick="handleAuthAction()" class="bg-primary-pink hover:bg-primary-purple transition px-3 py-1 md:px-4 md:py-2 rounded-lg text-sm font-bold flex items-center">
                    ÙˆØ±ÙˆØ¯
                </button>
            </div>
        </div>
    </header>

    <main id="app-container" class="container mx-auto p-4 page-transition">
        <div id="initial-loader" class="flex justify-center items-center min-h-[80vh]">
            <span class="text-xl animate-pulse text-primary-purple">ğŸŒ€ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡...</span>
        </div>
    </main>
    
    <div id="modal-container" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden justify-center items-center z-[100]">
        <div id="modal-content" class="glassmorphism p-6 max-w-sm w-full text-center border-l-4 border-primary-pink"></div>
    </div>
    
    <div id="confetti-container" class="fixed inset-0 pointer-events-none z-[99]"></div>

    <script>
        // --- 1. CONFIG & INITIALIZATION ---

        const appContainer = document.getElementById('app-container');
        const initialLoader = document.getElementById('initial-loader');
        let historyStack = []; 
        
        // Load State from LocalStorage
        let state = JSON.parse(localStorage.getItem('funbaz_state')) || {
            user: null, 
            isAuthenticated: false,
            score: 0,
            level: 1,
            rank: 'Ù…Ø¨ØªØ¯ÛŒ', 
            streak: 0,
            riddlesSolved: 0,
            testsCompleted: { mbti: 0, color: 0, memory: 0 }, 
            testTickets: { mbti: 1, color: 1, memory: 1 }, 
            gamesWon: 0, // Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ú©Ù„ÛŒÚ© Ø³Ø±ÛŒØ¹
            memoryGamesWon: 0, // Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø­Ø§ÙØ¸Ù‡
            dailyPlayed: new Date('1/1/2000').toDateString(), 
            lastPlayedDate: new Date('1/1/2000').toDateString(),
            theme: 'dark',
            badges: {}, 
            solvedRiddles: {}, 
            riddleChoices: {},
            userAvatar: 'ğŸ‘¤',
            // --- New Features State ---
            powerups: { doubleScore: 0, freeHint: 0 }, 
            rankBoosted: null, 
            // Leaderboard (Ø¨Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)
            leaderboard: [
                { username: 'Mister Fun', score: 1200, rank: 'Ø§Ø³ØªØ§Ø¯' },
                { username: 'TestUser', score: 800, rank: 'Ù¾ÛŒØ´Ø±ÙØªÙ‡' },
                { username: 'CoolCat', score: 550, rank: 'Ù…ØªÙˆØ³Ø·' },
                { username: 'Newbie', score: 100, rank: 'Ù…Ø¨ØªØ¯ÛŒ' },
            ],
            totalTestsCompleted: 0, 
        };
        
        // Ø§ØµÙ„Ø§Ø­ Ùˆ ØªÚ©Ù…ÛŒÙ„ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ ØµØ­ÛŒØ­
        if (!state.testsCompleted.memory) state.testsCompleted.memory = 0;
        if (!state.testTickets.memory) state.testTickets.memory = 1;
        if (!state.memoryGamesWon) state.memoryGamesWon = 0;
        if (!state.totalTestsCompleted) {
             state.totalTestsCompleted = Object.values(state.testsCompleted).reduce((sum, count) => sum + count, 0);
        }

        // --- 2. DATA (Ù…Ø­ØªÙˆØ§ÛŒ Ø³Ø§ÛŒØª) ---

        const CONTENT = {
            riddles: [
                { id: 1, cat: 'Ø¢Ø³Ø§Ù†', q: 'Ú†ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ù…ÛŒØ§Ø¯ ÙˆÙ„ÛŒ Ù†Ù…ÛŒâ€ŒØ±Ø³Ù‡ØŸ', a: 'ÙØ±Ø¯Ø§', p: 5, options: ['Ø§Ù…Ø±ÙˆØ²', 'Ø³Ø§Ø¹Øª', 'Ø¯ÛŒØ±ÙˆØ²'] },
                { id: 2, cat: 'Ø¢Ø³Ø§Ù†', q: 'Ú†Ù‡ Ú†ÛŒØ²ÛŒ Ø¯Ø§Ø±ÛŒ ÙˆÙ„ÛŒ Ù†Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù„Ù…Ø³Ø´ Ú©Ù†ÛŒØŸ', a: 'Ù†ÙØ³Øª', p: 5, options: ['Ø¯Ø±Ø®Øª', 'Ø³Ù†Ú¯', 'Ø¢Ø¨'] },
                { id: 3, cat: 'Ø¢Ø³Ø§Ù†', q: 'Ù‡Ø± Ø±ÙˆØ² Ù…ÛŒâ€ŒÙ…ÛŒØ±Ù… Ù‡Ø± Ø´Ø¨ Ø²Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´Ù…', a: 'Ø´Ù…Ø¹', p: 5, options: ['Ù…Ø§Ù‡', 'Ø®ÙˆØ±Ø´ÛŒØ¯', 'Ø³ØªØ§Ø±Ù‡'] },
                { id: 4, cat: 'Ù…ØªÙˆØ³Ø·', q: '3Ú©Ù„Ù…Ù‡:3+4+5Ø­Ø±Ù=Ø¨Ø²Ø±Ú¯ØªØ±ÛŒÙ†Ù…', a: 'Ø®Ø¯Ø§', p: 10, options: ['Ø¨Ø²Ø±Ú¯', 'Ø¹Ø´Ù‚', 'Ø²Ù†Ø¯Ú¯ÛŒ'] },
                { id: 5, cat: 'Ù…ØªÙˆØ³Ø·', q: 'Ù¾Ø¯Ø±Ù… Ù¾Ø³Ø±Ø¹Ù…ÙˆÛŒÙ…Ù‡', a: 'Ø®ÙˆØ¯Ù…', p: 10, options: ['Ø¯Ø§ÛŒÛŒ', 'Ø¹Ù…Ùˆ', 'Ø¨Ø±Ø§Ø¯Ø±'] },
                { id: 6, cat: 'Ø³Ø®Øª', q: 'Ù…Ù†Ùˆ Ø¨Ø®ÙˆØ±ÛŒ Ù…ÛŒâ€ŒÙ…ÛŒØ±ÛŒ', a: 'Ø³Ù…', p: 20, options: ['Ù†Ø§Ù†', 'Ø¢Ø¨', 'Ù‡ÙˆØ§'] },
                { id: 7, cat: 'Ø³Ø®Øª', q: 'Ù‡Ø± Ú†ÛŒ Ø¨ÛŒØ´ØªØ± Ø¨Ú¯ÛŒØ±ÛŒ Ú©Ù…ØªØ± Ù…ÛŒâ€ŒØ´Ù…', a: 'Ù†ÙØ³', p: 20, options: ['Ø®ÙˆØ§Ø¨', 'Ù¾ÙˆÙ„', 'ØºØ°Ø§'] },
            ],
            dailyRiddle: {
                q: 'Ø¢Ù† Ú†ÛŒØ³Øª Ú©Ù‡ Ø¨Ø¯ÙˆÙ† Ú©Ù„ÛŒØ¯ Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø§Ù…Ø§ Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÚ¯ÛŒØ±Ù‡ Ø¨Ø³ØªÙ‡ØŸ',
                a: 'ØªØ®Ù… Ù…Ø±Øº',
                hint: 'Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ø² Ø®ÙˆØ±Ø¯Ù† Ø¢Ù† Ø±Ø§ Ù…ÛŒâ€ŒØ´Ú©Ù†Ù†Ø¯.',
                points: 50,
            },
            tests: [
                 { key: 'mbti', title: 'ØªØ³Øª Ú©Ø§Ù…Ù„ MBTI', description: 'Û· Ø³ÙˆØ§Ù„ Ú©Ù„ÛŒØ¯ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¹ÛŒÛŒÙ† ØªÛŒÙ¾ Ø´Ø®ØµÛŒØªÛŒ Ú©Ø§Ù…Ù„ (Ø´Ø§Ù…Ù„ J/P).', points: 40, questions: [
                    { q: 'Û±. Ø¯Ø± Ù…Ù‡Ù…Ø§Ù†ÛŒâ€ŒÙ‡Ø§ØŒ Ø¨ÛŒØ´ØªØ±:', options: [{ text: 'Ø¨Ø§ Ø§ÙØ±Ø§Ø¯ Ø²ÛŒØ§Ø¯ ØµØ­Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯', value: 'E' }, { text: 'Ø¨Ø§ Ú†Ù†Ø¯ Ù†ÙØ± Ø¹Ù…ÛŒÙ‚ ØµØ­Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯', value: 'I' }] },
                    { q: 'Û². ÙˆÙ‚ØªÛŒ Ú†ÛŒØ²ÛŒ Ø±Ø§ ÛŒØ§Ø¯ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒØ¯ØŒ Ø¨ÛŒØ´ØªØ± Ø¨Ù‡:', options: [{ text: 'Ø¬Ø²Ø¦ÛŒØ§Øª Ø¹Ù…Ù„ÛŒ', value: 'S' }, { text: 'Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ Ùˆ ØªØ¦ÙˆØ±ÛŒâ€ŒÙ‡Ø§', value: 'N' }] },
                    { q: 'Û³. ØªØµÙ…ÛŒÙ…Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³:', options: [{ text: 'Ù…Ù†Ø·Ù‚ Ùˆ ØªØ­Ù„ÛŒÙ„', value: 'T' }, { text: 'Ø§Ø­Ø³Ø§Ø³Ø§Øª Ùˆ ØªØ£Ø«ÛŒØ± Ø¨Ø± Ø¯ÛŒÚ¯Ø±Ø§Ù†', value: 'F' }] },
                    { q: 'Û´. Ø²Ù†Ø¯Ú¯ÛŒ Ø±ÙˆØ²Ù…Ø±Ù‡ Ø´Ù…Ø§ Ø¨ÛŒØ´ØªØ±:', options: [{ text: 'Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø´Ø¯Ù‡ Ùˆ Ù…Ù†Ø¸Ù… Ø§Ø³Øª', value: 'J' }, { text: 'Ù‚Ø§Ø¨Ù„ Ø§Ù†Ø¹Ø·Ø§Ù Ùˆ Ø®ÙˆØ¯Ø¨Ù‡â€ŒØ®ÙˆØ¯ÛŒ Ø§Ø³Øª', value: 'P' }] },
                    { q: 'Ûµ. ØªØ±Ø¬ÛŒØ­ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯:', options: [{ text: 'Ø¨Ù‡ Ú¯Ø°Ø´ØªÙ‡ Ùˆ ØªØ¬Ø±Ø¨ÛŒØ§Øª Ø¨Ù¾Ø±Ø¯Ø§Ø²ÛŒØ¯', value: 'S' }, { text: 'Ø¨Ù‡ Ø¢ÛŒÙ†Ø¯Ù‡ Ùˆ Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª Ø¨Ù¾Ø±Ø¯Ø§Ø²ÛŒØ¯', value: 'N' }] },
                    { q: 'Û¶. Ø¯Ø± Ø¨Ø­Ø«â€ŒÙ‡Ø§ØŒ Ù‡Ø¯Ù Ø´Ù…Ø§:', options: [{ text: 'Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ø­Ù‚ÛŒÙ‚Øª Ø¨Ø¯ÙˆÙ† ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ø§Ø­Ø³Ø§Ø³Ø§Øª', value: 'T' }, { text: 'Ø­ÙØ¸ ØµÙ„Ø­ Ùˆ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ú¯Ø±ÙˆÙ‡', value: 'F' }] },
                    { q: 'Û·. Ø§ØºÙ„Ø¨ Ù…Ø±Ø¯Ù… Ø´Ù…Ø§ Ø±Ø§ ÙØ±Ø¯ÛŒ:', options: [{ text: 'Ø¬Ø¯ÛŒ Ùˆ Ù‚Ø§Ø·Ø¹ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ù†Ø¯', value: 'J' }, { text: 'Ø¢Ø±Ø§Ù… Ùˆ Ù…Ù†Ø¹Ø·Ù Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ù†Ø¯', value: 'P' }] },
                ]},
                 { key: 'color', title: 'ØªØ³Øª Ø±Ù†Ú¯ Ø²Ù†Ø¯Ú¯ÛŒ', description: 'Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ø±Ù†Ú¯ÛŒ Ø´Ù…Ø§ØŒ Ø´Ø®ØµÛŒØª Ùˆ Ø­Ø§Ù„Øª Ø±ÙˆØ­ÛŒ ØºØ§Ù„Ø¨ Ø´Ù…Ø§ Ø±Ø§ Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.', points: 25, questions: [
                    { q: 'Û±. ÙˆÙ‚ØªÛŒ ØªÙ†Ù‡Ø§ Ù‡Ø³ØªÛŒØ¯ØŒ Ø¨ÛŒØ´ØªØ±:', options: [{ text: 'Ø¨Ù‡ Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ ÙÚ©Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯', value: 'Yellow' }, { text: 'Ø¢Ø±Ø§Ù…Ø´ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯', value: 'Blue' }] },
                    { q: 'Û². Ø¯Ø± Ú¯Ø±ÙˆÙ‡ØŒ ÙˆØ¸ÛŒÙÙ‡ Ø´Ù…Ø§:', options: [{ text: 'Ø³Ø§Ø²Ù…Ø§Ù†Ø¯Ù‡ÛŒ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³Øª', value: 'Green' }, { text: 'ØªØ´ÙˆÛŒÙ‚ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø§Ø³Øª', value: 'Orange' }] },
                    { q: 'Û³. Ø±Ù†Ú¯ Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø§ØªØ§Ù‚ Ø®ÙˆØ§Ø¨:', options: [{ text: 'Ù‚Ø±Ù…Ø² ÛŒØ§ Ù†Ø§Ø±Ù†Ø¬ÛŒ (Ø§Ù†Ø±Ú˜ÛŒ)', value: 'Red' }, { text: 'Ø¢Ø¨ÛŒ ÛŒØ§ Ø¨Ù†ÙØ´ (Ø¢Ø±Ø§Ù…Ø´)', value: 'Blue' }] },
                    { q: 'Û´. Ø¯Ø± Ù„Ø¨Ø§Ø³ Ù¾ÙˆØ´ÛŒØ¯Ù†ØŒ Ø¨ÛŒØ´ØªØ±:', options: [{ text: 'Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ ØªÛŒØ±Ù‡ Ùˆ Ø±Ø³Ù…ÛŒ', value: 'Black' }, { text: 'Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ´Ù† Ùˆ Ø´Ø§Ø¯', value: 'White' }] },
                ]},
                 { key: 'memory', title: 'ØªØ³Øª Ø­Ø§ÙØ¸Ù‡ Ø¨ØµØ±ÛŒ (Pattern)', points: 35, description: 'Ø¢Ø²Ù…ÙˆÙ† ØªÙˆØ§Ù†Ø§ÛŒÛŒ Ø´Ù…Ø§ Ø¯Ø± Ø¨Ù‡ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø¨ØµØ±ÛŒ Ø¯Ø± Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ú©ÙˆØªØ§Ù‡.', questions: [] },
            ],
            games: [
                 { key: 'clicks', title: 'Ø¨Ø§Ø²ÛŒ Ø³Ø±Ø¹Øª Ú©Ù„ÛŒÚ©', description: 'Ø¯Ø± Û±Û° Ø«Ø§Ù†ÛŒÙ‡ Ø¨ÛŒØ´ØªØ±ÛŒÙ† ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ÛŒÚ© Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.', points: 20, path: 'games/clicks', icon: 'âš¡' },
                 { key: 'memory', title: 'Ø¨Ø§Ø²ÛŒ Ø­Ø§ÙØ¸Ù‡ Ú©Ø§Ø±ØªÛŒ', description: 'Ø¬ÙØª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ ÛŒÚ©Ø³Ø§Ù† Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒØ¯.', points: 25, path: 'games/memory', icon: 'ğŸ§ ' },
            ],
            avatars: ['ğŸ‘¤', 'ğŸ¤–', 'ğŸ‘‘', 'ğŸš€', 'â­', 'ğŸ¦„', 'ğŸ”¥', 'ğŸ’–'],
            badges: [
                { id: 'b1', title: 'Ù…Ø¨ØªØ¯ÛŒ Ù…Ø¹Ù…Ø§', cond: 'Ø­Ù„ Û±Û° Ù…Ø¹Ù…Ø§', field: 'riddlesSolved', goal: 10, type: 'Ø¨Ø±Ù†Ø²', icon: 'ğŸ§ ' },
                { id: 'b2', title: 'Ø§Ø³ØªØ±ÛŒÚ© Û· Ø±ÙˆØ²Ù‡', cond: 'Û· Ø±ÙˆØ² Ø¨Ø§Ø²ÛŒ Ù…ØªÙˆØ§Ù„ÛŒ', field: 'streak', goal: 7, type: 'Ø·Ù„Ø§', icon: 'ğŸ”¥' },
                { id: 'b3', title: 'ØªØ³Øª Ø¨Ø§Ø²', cond: 'ØªÚ©Ù…ÛŒÙ„ Ûµ ØªØ³Øª', field: 'totalTestsCompleted', goal: 5, type: 'Ù†Ù‚Ø±Ù‡', icon: 'ğŸ’–' }, 
                { id: 'b4', title: 'Ú©Ù„ÛŒÚ©Ø± Ø³Ø±ÛŒØ¹', cond: 'Ûµ Ø¨Ø§Ø²ÛŒ Ú©Ù„ÛŒÚ© Ø³Ø±ÛŒØ¹ Ø¨Ø±Ø¯Ù‡', field: 'gamesWon', goal: 5, type: 'Ø¨Ø±Ù†Ø²', icon: 'âš¡' },
                { id: 'b5', title: 'Ù‚Ù‡Ø±Ù…Ø§Ù† Ø­Ø§ÙØ¸Ù‡', cond: 'Ûµ Ø¨Ø§Ø²ÛŒ Ø­Ø§ÙØ¸Ù‡ Ø¨Ø±Ø¯Ù‡', field: 'memoryGamesWon', goal: 5, type: 'Ø·Ù„Ø§', icon: 'ğŸ§ ' },
            ],
            ranks: [
                 { name: 'Ù…Ø¨ØªØ¯ÛŒ', scoreMin: 0, color: 'text-gray-400' },
                 { name: 'Ø¹Ø§Ø¯ÛŒ', scoreMin: 200, color: 'text-green-400' },
                 { name: 'Ù¾ÛŒØ´Ø±ÙØªÙ‡', scoreMin: 500, color: 'text-blue-400' },
                 { name: 'Ø§Ø³ØªØ§Ø¯', scoreMin: 1000, color: 'text-rank-gold' },
                 { name: 'Ù„Ø§ÛŒØªâ€ŒØ¨Ø§Ø² (FUNBAZ)', scoreMin: 2000, color: 'text-primary-pink' },
            ],
            shopItems: [
                { id: 'item_reset_mbti', title: 'Ø¨Ù„ÛŒØ· Ø±ÛŒØ³Øª ØªØ³Øª MBTI', desc: 'Ø§Ù…Ú©Ø§Ù† Ø§Ù†Ø¬Ø§Ù… Ù…Ø¬Ø¯Ø¯ ØªØ³Øª Ø´Ø®ØµÛŒØª MBTI.', cost: 150, type: 'ticket', target: 'mbti', icon: 'ğŸŸï¸' },
                { id: 'item_reset_color', title: 'Ø¨Ù„ÛŒØ· Ø±ÛŒØ³Øª ØªØ³Øª Ø±Ù†Ú¯', desc: 'Ø§Ù…Ú©Ø§Ù† Ø§Ù†Ø¬Ø§Ù… Ù…Ø¬Ø¯Ø¯ ØªØ³Øª Ø±Ù†Ú¯ Ø²Ù†Ø¯Ú¯ÛŒ.', cost: 100, type: 'ticket', target: 'color', icon: 'ğŸŸï¸' },
                { id: 'powerup_double', title: 'Power-up Ø¯ÙˆØ¨Ø±Ø§Ø¨Ø±ÛŒ Ø§Ù…ØªÛŒØ§Ø²', desc: 'Ø§Ù…ØªÛŒØ§Ø² ÙØ¹Ø§Ù„ÛŒØª Ø¨Ø¹Ø¯ÛŒ Ø´Ù…Ø§ Ø±Ø§ Ø¯Ùˆ Ø¨Ø±Ø§Ø¨Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.', cost: 300, type: 'powerup', target: 'doubleScore', icon: 'âœ¨' },
                { id: 'powerup_hint', title: 'Power-up Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù†', desc: 'ÛŒÚ© Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ù…Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.', cost: 150, type: 'powerup', target: 'freeHint', icon: 'ğŸ’¡' },
                { id: 'rank_boost', title: 'Ø§Ø±ØªÙ‚Ø§Ø¡ Ù…Ù‚Ø§Ù… Ù…ÙˆÙ‚Øª (Û· Ø±ÙˆØ²)', desc: 'Ù…Ù‚Ø§Ù… Ø´Ù…Ø§ Ø±Ø§ ÛŒÚ© Ù¾Ù„Ù‡ Ø§Ø±ØªÙ‚Ø§Ø¡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.', cost: 1000, type: 'rank', target: 'boost', icon: 'ğŸ‘‘' },
                { id: 'item_avatar_king', title: 'Ø¢ÙˆØ§ØªØ§Ø± Ù¾Ø§Ø¯Ø´Ø§Ù‡', desc: 'Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¢ÙˆØ§ØªØ§Ø± Ù¾Ø§Ø¯Ø´Ø§Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„.', cost: 500, type: 'avatar', target: 'ğŸ‘‘', icon: 'ğŸ‘‘' },
            ],
        };
        
        // --- 3. UTILITIES & UI HELPERS ---

        function saveState() {
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø± Ù‡Ø¯Ø± Ù‚Ø¨Ù„ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡
            updateScoreDisplay(); 
            localStorage.setItem('funbaz_state', JSON.stringify(state));
        }
        
        function updateScoreDisplay() {
             const scoreEl = document.getElementById('current-score');
             if (scoreEl) {
                 scoreEl.textContent = state.score.toLocaleString();
             }
        }

        function showModal(message, type = 'info') {
            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');
            
            let color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-primary-pink';
            
            modalContent.innerHTML = `<p class="text-xl font-bold ${color}">${message}</p>
                                     <button onclick="document.getElementById('modal-container').style.display='none'" class="mt-4 px-4 py-2 bg-white/30 rounded-lg hover:bg-white/40 transition">Ø¨Ø³ØªÙ†</button>`;
            modalContainer.style.display = 'flex';
        }

        /**
         * Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ ØµÙØ­Ø§Øª
         * @param {string} page - Ù…Ø³ÛŒØ± ØµÙØ­Ù‡ (Ù…Ø«Ù„Ø§Ù‹ 'dashboard', 'tests/mbti-start')
         * @param {boolean} pushToHistory - Ø¢ÛŒØ§ Ø¨Ù‡ Ù¾Ø´ØªÙ‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯ ÛŒØ§ Ø®ÛŒØ± (Ø¨Ø±Ø§ÛŒ back)
         */
        function route(page, pushToHistory = true) {
            const currentPage = window.location.hash.substring(1);
            
            // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§ÙØ²ÙˆØ¯Ù† 'login' Ùˆ '404' Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
            if (pushToHistory && currentPage && currentPage !== page && page !== 'login' && page !== '404') {
                historyStack.push(currentPage);
            }

            window.location.hash = `#${page}`;
            renderPage(page);
        }
        
        /**
         * Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ù‚Ø¨Ù„ÛŒ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù¾Ø´ØªÙ‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
         */
        function goBack() {
            if (historyStack.length > 0) {
                const previousPage = historyStack.pop();
                // Ø¨Ø§ false Ø¨Ø±Ø§ÛŒ pushToHistory ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ù‡ Ù¾Ø´ØªÙ‡ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´ÙˆØ¯
                route(previousPage, false); 
            } else {
                route('dashboard', false); // Ø§Ú¯Ø± Ù¾Ø´ØªÙ‡ Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ØŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø±Ú¯Ø±Ø¯
            }
        }

        function updateNav() {
            const nav = document.getElementById('main-nav');
            const authButton = document.getElementById('auth-button');
            const scoreDisplay = document.getElementById('score-display');
            
            if (state.isAuthenticated) {
                nav.innerHTML = `
                    <a href="#dashboard" onclick="route('dashboard')" class="text-white hover:text-primary-pink transition">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
                    <a href="#riddles" onclick="route('riddles')" class="text-white hover:text-primary-pink transition">Ù…Ø¹Ù…Ø§Ù‡Ø§</a>
                    <a href="#tests" onclick="route('tests')" class="text-white hover:text-primary-pink transition">ØªØ³Øªâ€ŒÙ‡Ø§</a>
                    <a href="#games" onclick="route('games')" class="text-white hover:text-primary-pink transition">Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§</a>
                    <a href="#daily" onclick="route('daily')" class="text-white hover:text-primary-pink transition">Ú†Ø§Ù„Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡</a>
                    <a href="#shop" onclick="route('shop')" class="text-white hover:text-coin-gold transition">ğŸ›’ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</a>
                    <a href="#leaderboard" onclick="route('leaderboard')" class="text-white hover:text-rank-gold transition">ğŸ† Ù„ÛŒØ¯Ø±Ø¨Ø±Ø¯</a>
                `;
                 
                authButton.innerHTML = `<span class="text-xl ml-2">${state.userAvatar}</span> <span class="hidden md:inline">${state.user?.username || 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„'}</span>`;
                authButton.onclick = () => route('profile');
                authButton.classList.remove('bg-primary-pink', 'hover:bg-primary-purple');
                authButton.classList.add('bg-primary-purple/80', 'hover:bg-primary-purple');
                scoreDisplay.classList.remove('hidden');
            } else {
                nav.innerHTML = '';
                authButton.textContent = 'ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øª Ù†Ø§Ù…';
                authButton.onclick = () => route('login');
                authButton.classList.remove('bg-primary-purple/80', 'hover:bg-primary-purple');
                authButton.classList.add('bg-primary-pink', 'hover:bg-primary-purple');
                scoreDisplay.classList.add('hidden');
            }
        }
        
        function handleAuthAction() {
            if (state.isAuthenticated) {
                route('profile');
            } else {
                route('login');
            }
        }
        
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            document.documentElement.classList.toggle('light', !isDark);
            state.theme = isDark ? 'dark' : 'light';
            localStorage.setItem('theme', state.theme);
            document.getElementById('theme-toggle').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- 4. CORE LOGIC (LEVEL, SCORE, STREAK, BADGES) ---
        
        function addScore(points, fieldToIncrement = null, usePowerup = true) {
            let finalPoints = points;
            
            // Ø§Ø¹Ù…Ø§Ù„ Power-up Ø¯ÙˆØ¨Ø±Ø§Ø¨Ø±ÛŒ Ø§Ù…ØªÛŒØ§Ø²
            let powerupUsed = false;
            if (usePowerup && state.powerups.doubleScore > 0) {
                 finalPoints *= 2;
                 state.powerups.doubleScore -= 1;
                 powerupUsed = true;
            }
            
            state.score += finalPoints;
            
            const oldLevel = state.level;
            // ÙØ±Ù…ÙˆÙ„ Ø¬Ø¯ÛŒØ¯ Ù„ÙˆÙ„â€ŒØ¢Ù¾ (Ø³Ø®Øªâ€ŒØªØ±)
            const newLevel = Math.floor(1 + Math.log10(state.score + 10) * 5); 
            state.level = newLevel;
            
            if (newLevel > oldLevel) {
                showConfetti();
                showModal(`ğŸ‰ ØªØ¨Ø±ÛŒÚ©! Ø´Ù…Ø§ Ø¨Ù‡ Ù„ÙˆÙ„ ${newLevel} Ø±Ø³ÛŒØ¯ÛŒØ¯!`, 'success');
            }
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ù‚Ø§Ù… Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù…ØªÛŒØ§Ø²
            updateRank();

            // Ø§ÙØ²Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±
            if (fieldToIncrement) {
                if (fieldToIncrement.startsWith('testsCompleted.')) {
                    const testKey = fieldToIncrement.split('.')[1];
                    state.testsCompleted[testKey] = (state.testsCompleted[testKey] || 0) + 1;
                    state.totalTestsCompleted = Object.values(state.testsCompleted).reduce((sum, count) => sum + count, 0);
                } else if (state.hasOwnProperty(fieldToIncrement)) {
                    state[fieldToIncrement] += 1;
                } else if (fieldToIncrement === 'memoryGamesWon') {
                     state.memoryGamesWon = (state.memoryGamesWon || 0) + 1;
                } else if (fieldToIncrement === 'gamesWon') {
                     state.gamesWon = (state.gamesWon || 0) + 1;
                }
            }
            
            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Power-up
            if (powerupUsed) {
                 showModal(`ğŸŒŸ Power-up Ø¯ÙˆØ¨Ø±Ø§Ø¨Ø±ÛŒ Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯! Ø§Ù…ØªÛŒØ§Ø² Ú©Ø³Ø¨ Ø´Ø¯Ù‡: ${finalPoints}.`, 'success');
            }

            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù„ÛŒØ¯Ø±Ø¨Ø±Ø¯ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)
            updateLeaderboard(state.user?.username, state.score, state.rank);
            checkBadgeProgress();
            saveState();
        }

        function subtractScore(points) {
             if (state.score < points) {
                 return false;
             }
             state.score -= points;
             updateRank();
             updateLeaderboard(state.user?.username, state.score, state.rank);
             saveState();
             return true;
        }

        function updateRank() {
            const currentScore = state.score;
            let currentRank = state.rank;
            let bestRank = CONTENT.ranks[0];

            // Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØªÙ† Ø¨ÙˆØ³Øª Ù…Ù‚Ø§Ù…
            if (state.rankBoosted) {
                 const boostDate = new Date(state.rankBoosted);
                 const now = new Date();
                 const diffTime = Math.abs(now - boostDate);
                 const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                 
                 if (diffDays > 7) {
                     state.rankBoosted = null;
                     showModal('â° Ù…Ù‚Ø§Ù… Ø§Ø±ØªÙ‚Ø§Ø¡ ÛŒØ§ÙØªÙ‡ Ù…ÙˆÙ‚Øª Ø´Ù…Ø§ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯.', 'info');
                 }
            }
            
            // ØªØ¹ÛŒÛŒÙ† Ø±Ù†Ú© Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù…ØªÛŒØ§Ø²
            for (let i = CONTENT.ranks.length - 1; i >= 0; i--) {
                if (currentScore >= CONTENT.ranks[i].scoreMin) {
                    bestRank = CONTENT.ranks[i];
                    break;
                }
            }

            currentRank = bestRank.name;

            // Ø§Ø¹Ù…Ø§Ù„ Ø¨ÙˆØ³Øª Ø§Ú¯Ø± ÙØ¹Ø§Ù„ Ø§Ø³Øª
            if (state.rankBoosted) {
                 const rankIndex = CONTENT.ranks.findIndex(r => r.name === currentRank);
                 const boostedIndex = Math.min(rankIndex + 1, CONTENT.ranks.length - 1);
                 if (boostedIndex > rankIndex) {
                    currentRank = CONTENT.ranks[boostedIndex].name;
                 }
            }
            
            state.rank = currentRank;
        }
        
        function updateLeaderboard(username, score, rank) {
            if (!username) return;

            // Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù„ÛŒØ¯Ø±Ø¨Ø±Ø¯ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
            state.leaderboard = state.leaderboard.filter(u => u.username !== username);
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ
            state.leaderboard.push({ username, score, rank });
            
            // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ù„ÛŒØ¯Ø±Ø¨Ø±Ø¯ (Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²)
            state.leaderboard.sort((a, b) => b.score - a.score);
            
            // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ù„ÛŒØ¯Ø±Ø¨Ø±Ø¯ Ø¨Ù‡ Ù…Ø«Ù„Ø§ Û±Û° Ù†ÙØ±
            state.leaderboard = state.leaderboard.slice(0, 10);
        }

        function checkBadgeProgress() {
            CONTENT.badges.forEach(badge => {
                let current = 0;
                
                if (badge.field.includes('.')) {
                    const [parent, child] = badge.field.split('.');
                    if (parent === 'testsCompleted') {
                        current = state.totalTestsCompleted;
                    } else {
                        current = state[parent][child] || 0;
                    }
                } else if (badge.field === 'totalTestsCompleted') {
                     current = state.totalTestsCompleted;
                } else if (badge.field === 'memoryGamesWon') {
                    current = state.memoryGamesWon || 0;
                } else {
                    current = state[badge.field] || 0;
                }
                
                if (current >= badge.goal && !state.badges[badge.id]) {
                    state.badges[badge.id] = true;
                    showConfetti();
                    showModal(`ğŸ… Ø¨Ø¬ ${badge.title} (${badge.type}) Ø±Ø§ Ø¨Ø§Ø² Ú©Ø±Ø¯ÛŒØ¯!`, 'success');
                }
            });
        }
        
        function showConfetti() {
             // Confetti logic
            const container = document.getElementById('confetti-container');
            for (let i = 0; i < 50; i++) {
                const c = document.createElement('div');
                c.className = 'absolute w-2 h-2 rounded-full animate-confetti';
                c.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                c.style.left = `${Math.random() * 100}vw`;
                c.style.animationDelay = `${Math.random() * 0.5}s`;
                c.style.animationDuration = `${1.5 + Math.random()}s`;
                container.appendChild(c);
                setTimeout(() => c.remove(), 2000);
            }
        }

        // --- 5. PAGE RENDERING (Router) ---

        function renderPage(page) {
            // Ø­Ù„ Ù…Ø´Ú©Ù„ ØµÙØ­Ù‡ Ø®Ø§Ù„ÛŒ: Ø§Ø¨ØªØ¯Ø§ ØµÙØ­Ù‡ Ø±Ø§ Ù…Ø®ÙÛŒ Ú©Ù†ÛŒØ¯ØŒ Ø³Ù¾Ø³ Ù…Ø­ØªÙˆØ§ Ø±Ø§ Ø±Ù†Ø¯Ø± Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø± Ù†Ù‡Ø§ÛŒØª Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯.
            appContainer.style.opacity = '0'; 
            window.scrollTo(0, 0); 
            
            if (page === 'login' && state.isAuthenticated) { return route('dashboard', false); }
            if (page !== 'login' && !state.isAuthenticated) { return route('login', false); }
            
            let html = '';
            let title = 'ÙØ§Ù† Ø¨Ø§Ø²';

            const parts = page.split('/');
            const basePage = parts[0];
            const param = parts[1];
            
            switch (basePage) {
                case 'dashboard': html = renderDashboard(); title = 'Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯'; break;
                case 'login': html = renderLogin(); title = 'ÙˆØ±ÙˆØ¯/Ø«Ø¨Øª Ù†Ø§Ù…'; break;
                case 'riddles': html = renderRiddles(); title = 'Ù…Ø¹Ù…Ø§Ù‡Ø§'; break;
                case 'tests': 
                    if (param && param.endsWith('-start')) {
                         const testKey = param.replace('-start', '');
                         const test = CONTENT.tests.find(c => c.key === testKey);
                         html = renderTestStart(test); title = `Ø´Ø±ÙˆØ¹ ${test?.title || 'ØªØ³Øª'}`;
                    } else if (param && param.endsWith('-quiz')) { 
                         const testKey = param.replace('-quiz', '');
                         const test = CONTENT.tests.find(c => c.key === testKey);
                         html = renderTestQuiz(test); title = test?.title || 'ØªØ³Øª'; 
                    } else { html = renderPersonalityTests(); title = 'ØªØ³Øªâ€ŒÙ‡Ø§'; } // ØµÙØ­Ù‡ Ù„ÛŒØ³Øª ØªØ³Øªâ€ŒÙ‡Ø§
                    break;
                case 'daily': html = renderDailyChallenge(); title = 'Ú†Ø§Ù„Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡'; break;
                case 'games': 
                    if (param && param === 'clicks') { html = renderClickSpeedGame(); title = 'Ú©Ù„ÛŒÚ© Ø³Ø±ÛŒØ¹'; }
                    else if (param && param === 'memory') { html = renderMemoryGame(); title = 'Ø¨Ø§Ø²ÛŒ Ø­Ø§ÙØ¸Ù‡'; }
                    else { html = renderGamesList(); title = 'Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§'; } // ØµÙØ­Ù‡ Ù„ÛŒØ³Øª Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§
                    break;
                case 'shop': html = renderShop(); title = 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡'; break;
                case 'profile': html = renderProfile(); title = 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„'; break;
                case 'edit-profile': html = renderEditProfile(); title = 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„'; break;
                case 'leaderboard': html = renderLeaderboard(); title = 'Ø¬Ø¯ÙˆÙ„ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ'; break;
                case 'awards': html = renderAwards(); title = 'Ø¬ÙˆØ§ÛŒØ² Ùˆ Ù…Ø¯Ø§Ù„â€ŒÙ‡Ø§'; break;
                default: html = render404(); title = '404'; break;
            }
            
            document.title = `${title} | ÙØ§Ù† Ø¨Ø§Ø²`;
            appContainer.innerHTML = html;
            
            // Ø§Ø¬Ø±Ø§ÛŒ ØªÙˆØ§Ø¨Ø¹ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù‡Ø± ØµÙØ­Ù‡
            if (window[`init${basePage}Page`]) {
                window[`init${basePage}Page`](param);
            }
            updateNav(); 
            updateScoreDisplay(); 
            
            // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø¨Ø§ Ø§ÙÚ©Øª
            setTimeout(() => { appContainer.style.opacity = '1'; }, 50);
        }
        
        function render404() {
             return `<div class="text-center py-20 glassmorphism max-w-lg mx-auto p-10">
                        <span class="text-6xl mb-4">â“</span>
                        <h1 class="text-4xl font-bold text-red-400 mt-4">ØµÙØ­Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯ (404)</h1>
                        <p class="text-gray-300 mt-2">Ø¨Ù‡ Ù†Ø¸Ø± Ù…ÛŒâ€ŒØ±Ø³Ø¯ Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ ÛŒØ§ Ø¨Ø§Ú¯ Ø´Ø¯Ù‡ Ø§Ø³Øª!</p>
                        <button onclick="route('dashboard')" class="mt-8 px-6 py-3 bg-primary-pink rounded-lg hover:bg-primary-purple transition">
                            Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                        </button>
                    </div>`;
        }


        // --- 6. PAGE TEMPLATES (HTML GENERATION) ---

        function renderHeader(title, backButton = false) {
            const backHtml = backButton ? 
                `<button onclick="goBack()" class="p-2 ml-4 rounded-full bg-white/10 hover:bg-white/20 transition text-xl flex items-center justify-center w-10 h-10">
                    <svg class="rtl:rotate-180 w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>` : '';

            return `
                <div class="flex items-center mb-8 pb-4 border-b border-white/20">
                    ${backHtml}
                    <h1 class="text-3xl md:text-4xl font-bold text-yellow-300">
                        ${title}
                    </h1>
                </div>
            `;
        }
        
        // ************* LOGIN PAGE *************
        function renderLogin() {
             return `
                <div class="flex min-h-[90vh] items-center justify-center p-4"
                     style="background: linear-gradient(to bottom right, #4c1d95, #a855f7, #ec4899);">
                    
                    <div id="auth-box" class="glassmorphism max-w-lg w-full p-10 text-white shadow-2xl transition-all duration-700 animate-float">
                        <h1 class="text-4xl font-bold text-center mb-8 bg-clip-text text-transparent"
                            style="background-image: linear-gradient(to right, #f97316, #fde047);">
                            âœ¨ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ Ø¨Ù‡ ÙØ§Ù† Ø¨Ø§Ø² âœ¨
                        </h1>
                        <form id="auth-form" class="space-y-6">
                            <input id="username" type="text" placeholder="Ù†Ø§Ù… Ù…Ø³ØªØ¹Ø§Ø±" required class="w-full p-3 rounded-lg bg-white/10 border border-white/30 placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-pink-500 hidden" />
                            <input id="email" type="email" placeholder="Ø§ÛŒÙ…ÛŒÙ„" required class="w-full p-3 rounded-lg bg-white/10 border border-white/30 placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-pink-500" />
                            <input id="password" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" required class="w-full p-3 rounded-lg bg-white/10 border border-white/30 placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-pink-500" />
                            
                            <button type="submit" id="auth-submit-btn" class="w-full p-3 rounded-lg font-bold text-lg transition-all duration-300 transform hover:scale-[1.02]
                              bg-gradient-to-r from-pink-500 to-primary-purple hover:from-pink-600 hover:to-primary-purple/90 shadow-xl">
                              ÙˆØ±ÙˆØ¯
                            </button>
                        </form>
                        
                        <div class="text-center mt-4 text-sm">
                            <button id="toggle-mode" onclick="toggleAuthMode(true)" class="text-pink-300 hover:text-pink-500 transition-colors">
                              Ø­Ø³Ø§Ø¨ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯
                            </button>
                        </div>

                        <div id="auth-error" class="text-red-400 text-center mt-4 font-bold"></div>
                    </div>
                </div>
            `;
        }

        // ************* DASHBOARD PAGE *************
        function renderDashboard() {
            const username = state.user?.username || 'Ø¯ÙˆØ³Øª Ø¹Ø²ÛŒØ²';
            const badgesCount = Object.values(state.badges).filter(v => v).length;
            const streakText = state.streak === 0 ? 'Ø´Ø±ÙˆØ¹ Ú©Ù†!' : state.streak;

            return `
                <div class="py-5 md:py-10">
                    <div class="glassmorphism p-6 md:p-8 mb-8 md:mb-10 border-l-4 border-primary-pink">
                        <h2 class="text-xl md:text-3xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-amber-500">
                            Ø³Ù„Ø§Ù…ØŒ ${username}! Ø®ÙˆØ´ Ø¨Ø±Ú¯Ø´ØªÛŒ ğŸ‘‹
                        </h2>
                        
                         <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="p-3 bg-white/10 rounded-lg">
                                <p class="text-xs md:text-sm text-gray-300">Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„</p>
                                <p class="text-2xl md:text-3xl font-extrabold text-pink-400">${state.score.toLocaleString()}</p>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <p class="text-xs md:text-sm text-gray-300">Ù…Ù‚Ø§Ù… Ø´Ù…Ø§</p>
                                <p class="text-2xl md:text-3xl font-extrabold ${CONTENT.ranks.find(r => r.name === state.rank)?.color || 'text-rank-gold'}">${state.rank}</p>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <p class="text-xs md:text-sm text-gray-300">Ø§Ø³ØªØ±ÛŒÚ© Ø±ÙˆØ²Ø§Ù†Ù‡</p>
                                <p class="text-2xl md:text-3xl font-extrabold text-green-400">ğŸ”¥ ${streakText}</p>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg cursor-pointer hover:bg-white/20 transition" onclick="route('awards')">
                                <p class="text-xs md:text-sm text-gray-300">Ø¬ÙˆØ§ÛŒØ² Ú©Ø³Ø¨ Ø´Ø¯Ù‡</p>
                                <p class="text-2xl md:text-3xl font-extrabold text-blue-400">ğŸ… ${Object.values(state.badges).filter(v => v).length}</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-10">
                        <h3 class="text-2xl font-bold mb-4 border-b border-primary-purple pb-2">ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <a href="#riddles" onclick="route('riddles')" class="link-riddles p-5 rounded-xl transition transform hover:scale-[1.03] shadow-lg text-center font-bold">
                                <span class="text-3xl block mb-2">ğŸ’¡</span> Ù…Ø¹Ù…Ø§Ù‡Ø§ÛŒ ÙÚ©Ø±ÛŒ
                            </a>
                            <a href="#tests" onclick="route('tests')" class="link-tests p-5 rounded-xl transition transform hover:scale-[1.03] shadow-lg text-center font-bold">
                                <span class="text-3xl block mb-2">ğŸ’–</span> ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ø®ØµÛŒØª
                            </a>
                            <a href="#daily" onclick="route('daily')" class="link-daily p-5 rounded-xl transition transform hover:scale-[1.03] shadow-lg text-center font-bold">
                                <span class="text-3xl block mb-2">ğŸ“…</span> Ú†Ø§Ù„Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡
                            </a>
                            <a href="#games" onclick="route('games')" class="bg-gradient-to-r from-cyan-600 to-blue-500 p-5 rounded-xl transition transform hover:scale-[1.03] shadow-lg text-center font-bold">
                                <span class="text-3xl block mb-2">ğŸ®</span> Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³Ø±Ø¹ØªÛŒ
                            </a>
                        </div>
                    </div>
                    
                    <div class="mb-10">
                        <h3 class="text-2xl font-bold mb-4 border-b border-rank-gold pb-2 flex justify-between items-center">
                            <span>ğŸ† Ø¨Ø±ØªØ±ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²</span>
                            <button onclick="route('leaderboard')" class="text-sm text-gray-300 hover:text-rank-gold transition">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ø§Ù…Ù„</button>
                        </h3>
                        ${renderLeaderboardSnippet()}
                    </div>
                </div>
            `;
        }
        
        function renderLeaderboardSnippet() {
             const top3 = state.leaderboard.slice(0, 3);
             let html = top3.map((user, index) => {
                 let color = '';
                 let icon = '';
                 if (index === 0) { color = 'bg-rank-gold/20 border-rank-gold'; icon = 'ğŸ¥‡'; }
                 else if (index === 1) { color = 'bg-rank-silver/20 border-rank-silver'; icon = 'ğŸ¥ˆ'; }
                 else { color = 'bg-rank-bronze/20 border-rank-bronze'; icon = 'ğŸ¥‰'; }

                 return `
                    <div class="glassmorphism p-4 flex justify-between items-center ${color} border-l-4 rounded-lg shadow-xl mb-3">
                        <div class="flex items-center">
                            <span class="text-2xl ml-3">${icon}</span>
                            <span class="font-bold">${user.username}</span>
                            <span class="mr-2 text-xs p-1 rounded-full ${user.rank === state.rank ? 'bg-primary-pink' : 'bg-white/10'}">${user.rank}</span>
                        </div>
                        <div class="font-extrabold text-lg text-coin-gold flex items-center">
                             ğŸ’° ${user.score.toLocaleString()}
                        </div>
                    </div>
                 `;
             }).join('');
             
             if (top3.length === 0) {
                 html = '<p class="text-center py-5 text-gray-400">Ù„ÛŒØ¯Ø±Ø¨Ø±Ø¯ Ù‡Ù†ÙˆØ² Ø®Ø§Ù„ÛŒ Ø§Ø³Øª. Ø§ÙˆÙ„ÛŒÙ† Ù†ÙØ± Ø¨Ø§Ø´ÛŒØ¯!</p>';
             }
             
             return html;
        }

        // ************* RIDDLES PAGE *************
        function renderRiddles() {
             return `
                ${renderHeader('Ù…Ø¹Ù…Ø§Ù‡Ø§ÛŒ ÙÚ©Ø±ÛŒ', true)}
                
                <p class="text-gray-300 mb-6">Ù‡ÙˆØ´ Ùˆ Ù…Ù†Ø·Ù‚ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø§ Ù…Ø¹Ù…Ø§Ù‡Ø§ÛŒ Ù…Ø§ Ø¨Ù‡ Ú†Ø§Ù„Ø´ Ø¨Ú©Ø´ÛŒØ¯. Ø¨Ø§ Ø­Ù„ Ù‡Ø± Ù…Ø¹Ù…Ø§ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ú¯ÛŒØ±ÛŒØ¯!</p>
                
                <div class="space-y-6">
                    ${CONTENT.riddles.map(riddle => {
                        const isSolved = state.solvedRiddles[riddle.id];
                        const attempts = state.riddleChoices[riddle.id] ? Object.keys(state.riddleChoices[riddle.id]).length : 0;
                        const difficultyColor = riddle.cat === 'Ø¢Ø³Ø§Ù†' ? 'text-green-400' : riddle.cat === 'Ù…ØªÙˆØ³Ø·' ? 'text-yellow-400' : 'text-red-400';
                        
                        return `
                            <div id="riddle-${riddle.id}" class="glassmorphism p-5 rounded-xl border-l-4 ${isSolved ? 'border-green-500' : 'border-primary-purple'}">
                                <h3 class="text-xl font-bold mb-2 flex justify-between items-center">
                                    <span>${isSolved ? 'âœ…' : 'â“'} Ù…Ø¹Ù…Ø§ÛŒ ${riddle.id}</span>
                                    <span class="text-sm font-normal ${difficultyColor}">(${riddle.cat})</span>
                                </h3>
                                <p class="text-lg mb-4 text-gray-200">${riddle.q}</p>
                                
                                <div class="space-y-2">
                                    ${!isSolved ? shuffleArray([...riddle.options, riddle.a]).map(option => `
                                        <button onclick="checkRiddle(${riddle.id}, '${option}')" 
                                                class="riddle-choice w-full p-3 rounded-lg bg-white/10 text-white hover:bg-primary-purple/70 transition">
                                            ${option}
                                        </button>
                                    `).join('') : `
                                        <p class="text-green-400 font-bold text-center p-3 bg-green-900/50 rounded-lg">
                                            âœ… Ø­Ù„ Ø´Ø¯! Ø§Ù…ØªÛŒØ§Ø² Ú©Ø³Ø¨ Ø´Ø¯Ù‡: +${riddle.p}
                                        </p>
                                        <p class="text-sm text-gray-400 text-center">ØªØ¹Ø¯Ø§Ø¯ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§: ${attempts}</p>
                                    `}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function checkRiddle(id, choice) {
             const riddle = CONTENT.riddles.find(r => r.id === id);
             if (!riddle || state.solvedRiddles[id]) return;
             
             // Ø°Ø®ÛŒØ±Ù‡ ØªÙ„Ø§Ø´
             if (!state.riddleChoices[id]) state.riddleChoices[id] = {};
             state.riddleChoices[id][Date.now()] = choice;
             
             if (choice === riddle.a) {
                 state.solvedRiddles[id] = true;
                 addScore(riddle.p, 'riddlesSolved');
                 showModal(`ğŸ‰ Ø¢ÙØ±ÛŒÙ†! Ù…Ø¹Ù…Ø§ÛŒ ${id} Ø­Ù„ Ø´Ø¯. +${riddle.p} Ø§Ù…ØªÛŒØ§Ø² Ú©Ø³Ø¨ Ú©Ø±Ø¯ÛŒØ¯.`, 'success');
                 route('riddles', false); // Ø±ÙØ±Ø´ ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø­Ù„ Ø´Ø¯Ù‡
             } else {
                 showModal('âŒ Ø§Ø´ØªØ¨Ø§Ù‡ Ø¨ÙˆØ¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'error');
             }
        }
        
        // ************* DAILY CHALLENGE PAGE *************
        function renderDailyChallenge() {
            const today = new Date().toDateString();
            const alreadyPlayed = state.dailyPlayed === today;
            const hintUsed = state.dailyRiddleHintUsed === today;
            
            const hintButton = state.powerups.freeHint > 0 && !hintUsed ? 
                `<button onclick="useDailyHint()" class="p-3 bg-blue-500/80 hover:bg-blue-600 rounded-lg transition font-bold text-sm">
                    ğŸ’¡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Power-up Ø±Ø§Ù‡Ù†Ù…Ø§ (${state.powerups.freeHint} Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡)
                 </button>` : '';

            return `
                ${renderHeader('Ú†Ø§Ù„Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡', true)}
                
                <div class="glassmorphism p-6 md:p-8 max-w-2xl mx-auto text-center border-l-4 border-green-500">
                    <h2 class="text-3xl font-extrabold mb-4 text-green-400">
                        Ù…Ø¹Ù…Ø§ÛŒ Ø¨Ø²Ø±Ú¯ Ø§Ù…Ø±ÙˆØ² ğŸ“…
                    </h2>
                    <p class="text-lg mb-6 text-gray-200">
                        ${CONTENT.dailyRiddle.q}
                    </p>
                    <p class="text-sm text-gray-400 mb-6">
                        Ø§Ù…ØªÛŒØ§Ø² ÙˆÛŒÚ˜Ù‡: <span class="text-coin-gold font-bold">${CONTENT.dailyRiddle.points}</span> ğŸ’°
                    </p>
                    
                    ${!alreadyPlayed ? `
                        <form id="daily-form" onsubmit="submitDailyRiddle(event)">
                            <input type="text" id="daily-answer" placeholder="Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ (ÙØ§Ø±Ø³ÛŒ)" required
                                class="w-full p-3 rounded-lg bg-white/10 border border-white/30 placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-green-500 text-center" />
                            
                            <div class="mt-4 flex flex-col space-y-3">
                                <button type="submit" class="w-full p-3 rounded-lg font-bold text-lg transition-all duration-300 transform hover:scale-[1.02]
                                  bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 shadow-lg">
                                    Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®
                                </button>
                                ${hintButton}
                            </div>
                        </form>
                        
                        ${hintUsed ? `
                            <p class="mt-4 p-3 bg-blue-900/50 rounded-lg text-blue-300 font-bold">
                                ğŸ’¡ Ø±Ø§Ù‡Ù†Ù…Ø§: ${CONTENT.dailyRiddle.hint}
                            </p>
                        ` : ''}

                    ` : `
                        <p class="text-xl font-bold text-pink-400 p-4 bg-white/10 rounded-lg">
                            âœ… Ø´Ù…Ø§ Ø§Ù…Ø±ÙˆØ² Ø¯Ø± Ú†Ø§Ù„Ø´ Ø´Ø±Ú©Øª Ú©Ø±Ø¯ÛŒØ¯. ÙØ±Ø¯Ø§ Ø¨Ø±Ú¯Ø±Ø¯ÛŒØ¯!
                        </p>
                    `}
                </div>
            `;
        }
        
        function submitDailyRiddle(e) {
             e.preventDefault();
             const answer = document.getElementById('daily-answer').value.trim();
             const correctAnswer = CONTENT.dailyRiddle.a;
             
             if (answer === correctAnswer) {
                 // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø³ØªØ±ÛŒÚ©
                 updateStreak(); 
                 
                 state.dailyPlayed = new Date().toDateString();
                 addScore(CONTENT.dailyRiddle.points);
                 showConfetti();
                 showModal(`ğŸ¥³ Ø¹Ø§Ù„ÛŒ Ø¨ÙˆØ¯! +${CONTENT.dailyRiddle.points} Ø§Ù…ØªÛŒØ§Ø² Ú©Ø³Ø¨ Ú©Ø±Ø¯ÛŒØ¯.`, 'success');
             } else {
                 showModal('âŒ Ù¾Ø§Ø³Ø® Ø§Ø´ØªØ¨Ø§Ù‡ Ø¨ÙˆØ¯. Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø´Ø§Ù†Ø³ Ø§Ù…Ø±ÙˆØ² Ø´Ù…Ø§ Ø§Ø² Ø¯Ø³Øª Ø±ÙØª.', 'error');
                 state.dailyPlayed = new Date().toDateString(); // Ø¨Ø§Ø²ÛŒ Ú©Ø±Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                 state.streak = 0; // Ø§Ø³ØªØ±ÛŒÚ© Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯
             }
             saveState();
             route('daily', false);
        }
        
        function useDailyHint() {
             if (state.powerups.freeHint > 0) {
                 state.powerups.freeHint -= 1;
                 state.dailyRiddleHintUsed = new Date().toDateString();
                 showModal(`ğŸ’¡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯. Ø¨Ù‡ Ù…Ø¹Ù…Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ø±Ú¯Ø±Ø¯ÛŒØ¯.`, 'info');
                 saveState();
                 route('daily', false);
             } else {
                 showModal('âŒ Ø´Ù…Ø§ Power-up Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù† Ù†Ø¯Ø§Ø±ÛŒØ¯.', 'error');
             }
        }
        
        function updateStreak() {
             const today = new Date();
             const yesterday = new Date(today);
             yesterday.setDate(today.getDate() - 1);
             
             const lastPlayedDate = new Date(state.lastPlayedDate).toDateString();
             
             if (lastPlayedDate === yesterday.toDateString()) {
                 state.streak += 1;
                 showModal(`ğŸ”¥ Ø§Ø³ØªØ±ÛŒÚ© Ø´Ù…Ø§ Ø­ÙØ¸ Ø´Ø¯! Ø§Ø³ØªØ±ÛŒÚ© ÙØ¹Ù„ÛŒ: ${state.streak} Ø±ÙˆØ².`, 'info');
             } else if (lastPlayedDate !== today.toDateString()) {
                 state.streak = 1;
                 showModal('ğŸ”¥ Ø§Ø³ØªØ±ÛŒÚ© Ø¬Ø¯ÛŒØ¯ Ø´Ù…Ø§ Ø´Ø±ÙˆØ¹ Ø´Ø¯! Û± Ø±ÙˆØ².', 'info');
             }
             
             state.lastPlayedDate = today.toDateString();
             checkBadgeProgress();
        }

        // ************* TESTS PAGE (LIST) *************
        function renderPersonalityTests() {
             return `
                ${renderHeader('ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ø®ØµÛŒØª Ùˆ Ù‡ÙˆØ´', true)}
                
                <p class="text-gray-300 mb-6">Ø¨Ø§ Ø§Ù†Ø¬Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„ÙØŒ Ø´Ø®ØµÛŒØª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø´Ù†Ø§Ø³ÛŒØ¯ Ùˆ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ú¯ÛŒØ±ÛŒØ¯. Ù‡Ø± ØªØ³Øª Ø¨Ù‡ Û± Ø¨Ù„ÛŒØ· Ù†ÛŒØ§Ø² Ø¯Ø§Ø±Ø¯.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${CONTENT.tests.map(test => {
                        const isAvailable = state.testTickets[test.key] > 0;
                        const timesCompleted = state.testsCompleted[test.key] || 0;
                        const actionText = isAvailable ? 'Ø´Ø±ÙˆØ¹ ØªØ³Øª' : 'Ø¨Ù„ÛŒØ· Ø¨Ø®Ø±';
                        const bgColor = isAvailable ? 'bg-primary-pink/90 hover:bg-primary-pink' : 'bg-gray-700/50 cursor-not-allowed';
                        
                        return `
                            <div class="quiz-card p-5 rounded-xl border-t-4 ${isAvailable ? 'border-pink-400' : 'border-gray-500'} shadow-xl">
                                <h3 class="text-2xl font-bold mb-2 text-pink-300">${test.title}</h3>
                                <p class="text-sm text-gray-400 mb-3">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡: <span class="font-bold text-white">${timesCompleted}</span> Ø¨Ø§Ø±</p>
                                <p class="text-md text-gray-200 mb-4">${test.description}</p>
                                <p class="text-sm text-coin-gold font-bold mb-4">Ø§Ù…ØªÛŒØ§Ø² Ø¬Ø§ÛŒØ²Ù‡: +${test.points}</p>
                                
                                <button onclick="${isAvailable ? `route('tests/${test.key}-start')` : `route('shop')`}"
                                        class="w-full p-3 rounded-lg font-bold transition ${bgColor}">
                                    ${actionText} (${state.testTickets[test.key] || 0} Ø¨Ù„ÛŒØ·)
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // ************* TEST START PAGE *************
        function renderTestStart(test) {
             if (!test) return render404();
             
             // Ú†Ú© Ú©Ø±Ø¯Ù† Ø¨Ù„ÛŒØ· Ù‚Ø¨Ù„ Ø§Ø² Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø´Ø±ÙˆØ¹
             if (state.testTickets[test.key] <= 0) {
                 showModal('âŒ Ø´Ù…Ø§ Ø¨Ù„ÛŒØ· Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªØ³Øª Ù†Ø¯Ø§Ø±ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø®Ø±ÛŒØ¯ Ú©Ù†ÛŒØ¯.', 'error');
                 return renderPersonalityTests();
             }
             
             let infoText = '';
             if (test.key === 'mbti') {
                 infoText = 'Ø§ÛŒÙ† ØªØ³Øª Û· Ø³ÙˆØ§Ù„ÛŒØŒ Ø®Ù„Ø§ØµÙ‡â€ŒØ§ÛŒ Ø§Ø² ØªÛŒÙ¾ Ø´Ø®ØµÛŒØªÛŒ Ø´Ù…Ø§ Ø±Ø§ Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒÚ©Ù†Ø¯. ØµØ§Ø¯Ù‚Ø§Ù†Ù‡ Ù¾Ø§Ø³Ø® Ø¯Ù‡ÛŒØ¯.';
             } else if (test.key === 'color') {
                 infoText = 'Ø¨Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ø±Ù†Ú¯â€ŒÙ‡Ø§ØŒ Ø­Ø§Ù„Øª Ø±ÙˆØ­ÛŒ Ùˆ Ø´Ø®ØµÛŒØª ØºØ§Ù„Ø¨ Ø®ÙˆØ¯ Ø±Ø§ Ú©Ø´Ù Ú©Ù†ÛŒØ¯.';
             } else if (test.key === 'memory') {
                  infoText = 'Ø¯Ø± Ø§ÛŒÙ† ØªØ³ØªØŒ Ø§Ø¨ØªØ¯Ø§ Ø§Ù„Ú¯ÙˆÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø±Ø§ Ø¨Ù‡ Ø®Ø§Ø·Ø± Ø¨Ø³Ù¾Ø§Ø±ÛŒØ¯. Ø³Ù¾Ø³ Ø¢Ù† Ø±Ø§ Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯.';
             }

             return `
                ${renderHeader(test.title, true)}
                
                <div class="glassmorphism p-6 md:p-8 max-w-2xl mx-auto text-center border-l-4 border-pink-400">
                    <h2 class="text-3xl font-bold mb-4 text-pink-300">Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ</h2>
                    <p class="text-lg text-gray-200 mb-6">${infoText}</p>
                    <p class="text-sm text-gray-400 mb-6">
                        Ø§ÛŒÙ† ØªØ³Øª Û± Ø¨Ù„ÛŒØ· Ø§Ø² Ø´Ù…Ø§ Ú©Ø³Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
                        <span class="text-coin-gold font-bold ml-2">Ø¬Ø§ÛŒØ²Ù‡: +${test.points} ğŸ’°</span>
                    </p>
                    
                    <button onclick="startQuiz('${test.key}')" 
                            class="w-full p-4 rounded-lg font-bold text-xl transition-all duration-300 transform hover:scale-[1.03]
                              bg-gradient-to-r from-primary-purple to-pink-500 shadow-lg">
                        Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯!
                    </button>
                </div>
            `;
        }
        
        // ************* TEST QUIZ PAGE (MBTI/COLOR) *************
        let currentQuizData = { testKey: '', answers: {}, currentQuestionIndex: 0 };
        
        function renderTestQuiz(test) {
             if (!test || test.questions.length === 0) return render404();
             
             // Ø§Ú¯Ø± Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± ÙˆØ§Ø±Ø¯ Ú©ÙˆÛŒÛŒØ² Ø´Ø¯Ù‡
             if (currentQuizData.testKey !== test.key) {
                 currentQuizData = { testKey: test.key, answers: {}, currentQuestionIndex: 0 };
             }
             
             const q = test.questions[currentQuizData.currentQuestionIndex];
             if (!q) { 
                 // Ø§Ú¯Ø± Ø³ÙˆØ§Ù„ÛŒ Ø¨Ø§Ù‚ÛŒ Ù†Ù…Ø§Ù†Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ù†ØªÛŒØ¬Ù‡ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
                 return calculateTestResult(test);
             }

             return `
                ${renderHeader(test.title, true)}
                
                <div class="glassmorphism p-6 md:p-8 max-w-3xl mx-auto border-l-4 border-pink-400">
                    <div class="mb-4 flex justify-between items-center">
                        <p class="text-xl font-bold text-pink-300">Ø³ÙˆØ§Ù„ ${currentQuizData.currentQuestionIndex + 1} Ø§Ø² ${test.questions.length}</p>
                        <div class="w-1/2 bg-white/10 rounded-full h-2.5">
                            <div class="bg-pink-500 h-2.5 rounded-full transition-all duration-500" 
                                 style="width: ${((currentQuizData.currentQuestionIndex + 1) / test.questions.length) * 100}%"></div>
                        </div>
                    </div>
                    
                    <h2 class="text-2xl font-bold mb-6 text-gray-100">${q.q}</h2>
                    
                    <div class="space-y-4">
                        ${q.options.map(option => `
                            <button onclick="submitQuizAnswer('${test.key}', '${option.value}')"
                                    class="w-full p-4 rounded-lg bg-white/10 text-lg hover:bg-primary-purple/70 transition transform hover:scale-[1.01]">
                                ${option.text}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function startQuiz(testKey) {
             // Ú©Ø³Ø± Ø¨Ù„ÛŒØ· Ù‡Ù†Ú¯Ø§Ù… Ø´Ø±ÙˆØ¹
             if (state.testTickets[testKey] <= 0) {
                 showModal('âŒ Ø´Ù…Ø§ Ø¨Ù„ÛŒØ· Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªØ³Øª Ù†Ø¯Ø§Ø±ÛŒØ¯.', 'error');
                 return;
             }
             
             // Ø¯Ø± Ù…ÙˆØ±Ø¯ ØªØ³Øª Ø­Ø§ÙØ¸Ù‡ØŒ Ø¨Ù‡ ØµÙØ­Ù‡ Ø¨Ø§Ø²ÛŒ Ø±ÛŒØ¯Ø§ÛŒØ±Ú©Øª Ú©Ù† (Ø§ÛŒÙ† ØªØ³Øª Ø¯Ø± Ù„ÛŒØ³Øª ØªØ³Øªâ€ŒÙ‡Ø§ Ù†Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ø´Ø¯ Ø§Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø­ÙØ¸ Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø§ÛŒÙ† Ú©Ø§Ø± Ø±Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…)
             if (testKey === 'memory') {
                 route('games/memory');
                 return;
             }
             
             // Ú©Ø³Ø± Ø¨Ù„ÛŒØ· (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ØºÛŒØ± Ø¨Ø§Ø²ÛŒ)
             state.testTickets[testKey] -= 1; 
             saveState();
             
             // Ø´Ø±ÙˆØ¹ ÙˆØ§Ù‚Ø¹ÛŒ Ú©ÙˆÛŒÛŒØ²
             currentQuizData = { testKey: testKey, answers: {}, currentQuestionIndex: 0 };
             route(`tests/${testKey}-quiz`);
        }
        
        function submitQuizAnswer(testKey, answer) {
             const test = CONTENT.tests.find(c => c.key === testKey);
             if (!test) return;

             currentQuizData.answers[currentQuizData.currentQuestionIndex] = answer;
             currentQuizData.currentQuestionIndex++;
             
             if (currentQuizData.currentQuestionIndex >= test.questions.length) {
                 // Ù¾Ø§ÛŒØ§Ù† Ú©ÙˆÛŒÛŒØ²
                 calculateTestResult(test);
             } else {
                 // Ø³ÙˆØ§Ù„ Ø¨Ø¹Ø¯ÛŒ
                 route(`tests/${testKey}-quiz`, false); // Ø±ÙØ±Ø´ ØµÙØ­Ù‡ Ø¨Ø¯ÙˆÙ† Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
             }
        }
        
        function calculateTestResult(test) {
             let resultTitle = '';
             let resultDesc = '';
             
             // **Ù…Ù†Ø·Ù‚ Ù…Ø­Ø§Ø³Ø¨Ù‡ MBTI**
             if (test.key === 'mbti') {
                 const answers = Object.values(currentQuizData.answers);
                 const counts = answers.reduce((acc, val) => {
                    acc[val] = (acc[val] || 0) + 1;
                    return acc;
                 }, {});

                 const E_I = (counts['E'] || 0) > (counts['I'] || 0) ? 'E' : 'I';
                 const S_N = (counts['S'] || 0) > (counts['N'] || 0) ? 'S' : 'N';
                 const T_F = (counts['T'] || 0) > (counts['F'] || 0) ? 'T' : 'F';
                 const J_P = (counts['J'] || 0) > (counts['P'] || 0) ? 'J' : 'P';

                 const type = E_I + S_N + T_F + J_P;
                 
                 resultTitle = `ØªÛŒÙ¾ Ø´Ø®ØµÛŒØªÛŒ Ø´Ù…Ø§: ${type}`;
                 resultDesc = `Ø´Ù…Ø§ Ø¯Ø± Ø§ÛŒÙ† ØªØ³Øª Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ØªÛŒÙ¾ **${type}** Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯ÛŒØ¯. (Ø§ÛŒÙ† ÛŒÚ© ØªØ³Øª Ø³Ø±Ú¯Ø±Ù…ÛŒ Ø§Ø³Øª)`;
                 
             // **Ù…Ù†Ø·Ù‚ Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ³Øª Ø±Ù†Ú¯**
             } else if (test.key === 'color') {
                 const answers = Object.values(currentQuizData.answers);
                 const colorCounts = answers.reduce((acc, val) => {
                    acc[val] = (acc[val] || 0) + 1;
                    return acc;
                 }, {});

                 let maxColor = 'None';
                 let maxCount = 0;
                 for (const color in colorCounts) {
                     if (colorCounts[color] > maxCount) {
                         maxCount = colorCounts[color];
                         maxColor = color;
                     }
                 }
                 
                 resultTitle = `Ø±Ù†Ú¯ Ø²Ù†Ø¯Ú¯ÛŒ Ø´Ù…Ø§: ${maxColor}`;
                 resultDesc = `Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ØŒ Ø±Ù†Ú¯ ${maxColor} Ø­Ø§Ù„Øª ØºØ§Ù„Ø¨ Ø±ÙˆØ­ÛŒ Ø´Ù…Ø§ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.`;
             }
             
             // **Ù…Ù†Ø·Ù‚ Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ Ùˆ Ø±Ù†Ø¯Ø± Ù†Ù‡Ø§ÛŒÛŒ**
             addScore(test.points, `testsCompleted.${test.key}`, true);
             
             appContainer.innerHTML = `
                ${renderHeader(`Ù†ØªÛŒØ¬Ù‡ ØªØ³Øª ${test.title}`, true)}
                
                <div class="glassmorphism p-6 md:p-10 max-w-3xl mx-auto text-center border-l-4 border-green-500">
                    <span class="text-6xl block mb-4">ğŸ†</span>
                    <h2 class="text-4xl font-extrabold mb-4 text-green-400">${resultTitle}</h2>
                    <p class="text-lg text-gray-200 mb-6">${resultDesc}</p>
                    <p class="text-2xl font-bold text-coin-gold mb-8">
                         Ø´Ù…Ø§ +${test.points} Ø§Ù…ØªÛŒØ§Ø² Ú©Ø³Ø¨ Ú©Ø±Ø¯ÛŒØ¯! ğŸ’°
                    </p>
                    
                    <button onclick="route('tests')" class="mt-4 px-6 py-3 bg-primary-purple rounded-lg hover:bg-primary-pink transition font-bold">
                        Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª ØªØ³Øªâ€ŒÙ‡Ø§
                    </button>
                </div>
             `;
             currentQuizData = { testKey: '', answers: {}, currentQuestionIndex: 0 }; // Ø±ÛŒØ³Øª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        }


        // ************* GAMES PAGE (LIST) *************
        function renderGamesList() {
             return `
                ${renderHeader('Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³Ø±Ú¯Ø±Ù…ÛŒ', true)}
                
                <p class="text-gray-300 mb-6">Ø³Ø±Ø¹Øª Ùˆ Ù…Ù‡Ø§Ø±Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø³Ù†Ø¬ÛŒØ¯! Ù‡Ø± Ø¨Ø§Ø²ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ Ø´Ù…Ø§ Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ø¬ÙˆØ§ÛŒØ² Ø¨ÛŒØ´ØªØ±ÛŒ Ø¨Ø¯Ù‡Ø¯.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${CONTENT.games.map(game => {
                        const timesWon = game.key === 'memory' ? state.memoryGamesWon : state.gamesWon;
                        const bgColor = game.key === 'clicks' ? 'bg-orange-500/90 hover:bg-orange-600' : 'bg-blue-500/90 hover:bg-blue-600';

                        return `
                            <div class="quiz-card p-5 rounded-xl border-t-4 border-yellow-400 shadow-xl">
                                <h3 class="text-2xl font-bold mb-2 text-yellow-300">${game.icon} ${game.title}</h3>
                                <p class="text-sm text-gray-400 mb-3">Ø¨Ø±Ø¯Ù‡Ø§: <span class="font-bold text-white">${timesWon}</span></p>
                                <p class="text-md text-gray-200 mb-4">${game.description}</p>
                                <p class="text-sm text-coin-gold font-bold mb-4">Ø§Ù…ØªÛŒØ§Ø² Ø¬Ø§ÛŒØ²Ù‡: +${game.points}</p>
                                
                                <button onclick="route('games/${game.key}')"
                                        class="w-full p-3 rounded-lg font-bold transition ${bgColor}">
                                    Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // ************* CLICK SPEED GAME PAGE *************
        let clickGameData = { timer: null, timeLeft: 10, clicks: 0, isActive: false };

        function renderClickSpeedGame() {
            return `
                ${renderHeader('Ø¨Ø§Ø²ÛŒ Ø³Ø±Ø¹Øª Ú©Ù„ÛŒÚ©', true)}
                
                <div class="glassmorphism p-6 md:p-8 max-w-xl mx-auto text-center border-l-4 border-orange-400">
                    <h2 class="text-3xl font-bold mb-4 text-orange-300">Ú†Ù‚Ø¯Ø± Ø³Ø±ÛŒØ¹ Ú©Ù„ÛŒÚ© Ù…ÛŒâ€ŒÚ©Ù†ÛŒØŸ</h2>
                    <p class="text-lg text-gray-200 mb-6">Ø¯Ø± Û±Û° Ø«Ø§Ù†ÛŒÙ‡ØŒ ØªØ§ Ø¬Ø§ÛŒÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø±ÙˆÛŒ Ø¯Ø§ÛŒØ±Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.</p>
                    
                    <div id="game-status" class="text-2xl font-bold mb-4">
                        <span id="game-timer">10.0</span> Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡
                    </div>
                    
                    <div id="game-result" class="text-xl font-bold text-coin-gold mb-6 hidden"></div>
                    
                    <button id="click-area" onclick="handleGameClick()" 
                            class="w-48 h-48 rounded-full bg-red-600 text-white text-4xl font-extrabold transition transform hover:scale-[1.05] shadow-2xl disabled:opacity-50">
                        Ø´Ø±ÙˆØ¹!
                    </button>
                    
                    <p class="text-sm mt-4 text-gray-300">Ú©Ù„ÛŒÚ©â€ŒÙ‡Ø§: <span id="click-count" class="font-bold">0</span></p>

                    <button id="restart-button" onclick="initClickSpeedGame()" class="hidden mt-4 px-6 py-3 bg-primary-purple rounded-lg hover:bg-primary-pink transition font-bold">
                        Ø¨Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯
                    </button>
                </div>
            `;
        }
        
        function initclicksPage() {
             initClickSpeedGame();
        }

        function initClickSpeedGame() {
            clearInterval(clickGameData.timer);
            clickGameData = { timer: null, timeLeft: 10, clicks: 0, isActive: false };
            
            document.getElementById('game-timer').textContent = '10.0';
            document.getElementById('click-count').textContent = '0';
            document.getElementById('game-result').classList.add('hidden');
            
            const clickArea = document.getElementById('click-area');
            clickArea.textContent = 'Ø´Ø±ÙˆØ¹!';
            clickArea.disabled = false;
            clickArea.onclick = startClickGame;
            clickArea.classList.remove('animate-shake');
            document.getElementById('restart-button').classList.add('hidden');
        }

        function startClickGame() {
            if (clickGameData.isActive) return;
            clickGameData.isActive = true;
            document.getElementById('click-area').textContent = 'Ú©Ù„ÛŒÚ©!';
            document.getElementById('click-area').onclick = handleGameClick;

            clickGameData.timer = setInterval(() => {
                clickGameData.timeLeft -= 0.1;
                document.getElementById('game-timer').textContent = clickGameData.timeLeft.toFixed(1);

                if (clickGameData.timeLeft <= 0) {
                    clearInterval(clickGameData.timer);
                    endClickGame();
                }
            }, 100);
        }

        function handleGameClick() {
            if (!clickGameData.isActive) return;
            clickGameData.clicks++;
            document.getElementById('click-count').textContent = clickGameData.clicks;
        }

        function endClickGame() {
            clickGameData.isActive = false;
            document.getElementById('click-area').disabled = true;
            document.getElementById('click-area').textContent = 'Ù¾Ø§ÛŒØ§Ù†';
            document.getElementById('restart-button').classList.remove('hidden');

            const scoreThreshold = 50; 
            const gamePoints = CONTENT.games.find(g => g.key === 'clicks').points;
            
            let resultMessage = `ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ÛŒÚ©: ${clickGameData.clicks}. `;

            if (clickGameData.clicks >= scoreThreshold) {
                resultMessage += `Ø´Ù…Ø§ Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯ÛŒØ¯ Ùˆ +${gamePoints} Ø§Ù…ØªÛŒØ§Ø² Ú¯Ø±ÙØªÛŒØ¯! ğŸ†`;
                addScore(gamePoints, 'gamesWon');
            } else {
                resultMessage += `Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù†ØªÙˆØ§Ù†Ø³ØªÛŒØ¯ Ø¨Ù‡ Ù‡Ø¯Ù ${scoreThreshold} Ú©Ù„ÛŒÚ© Ø¨Ø±Ø³ÛŒØ¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.`;
            }

            document.getElementById('game-result').textContent = resultMessage;
            document.getElementById('game-result').classList.remove('hidden');
        }
        
        // ************* MEMORY GAME PAGE *************
        let memoryGameData = {
            cards: [],
            gridSize: 4, 
            flippedCards: [],
            matchedPairs: 0,
            canFlip: true,
            timer: null,
            timeElapsed: 0,
            moves: 0
        };

        function renderMemoryGame() {
            return `
                ${renderHeader('Ø¨Ø§Ø²ÛŒ Ø­Ø§ÙØ¸Ù‡ Ú©Ø§Ø±ØªÛŒ', true)}
                
                <div class="glassmorphism p-6 md:p-8 max-w-xl mx-auto text-center border-l-4 border-blue-400">
                    <h2 class="text-3xl font-bold mb-4 text-blue-300">Ø¬ÙØªâ€ŒÙ‡Ø§ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†!</h2>
                    <p class="text-lg text-gray-200 mb-4">ØªÙ…Ø§Ù… Ø¬ÙØªâ€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø± Ú©Ù…ØªØ±ÛŒÙ† Ø²Ù…Ø§Ù† Ùˆ Ø­Ø±Ú©Øª Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒØ¯.</p>
                    
                    <div class="flex justify-between items-center mb-6 text-lg font-bold">
                        <div>â±ï¸ Ø²Ù…Ø§Ù†: <span id="memory-timer">0</span></div>
                        <div>ğŸ”„ Ø­Ø±Ú©Øª: <span id="memory-moves">0</span></div>
                    </div>

                    <div id="memory-grid" class="grid grid-cols-4 gap-2 md:gap-4 p-4 bg-white/10 rounded-lg">
                        </div>
                    
                    <div id="memory-result" class="text-xl font-bold text-green-400 mt-6 hidden"></div>

                    <button id="memory-restart" onclick="initMemoryGame()" class="mt-4 px-6 py-3 bg-primary-purple rounded-lg hover:bg-primary-pink transition font-bold">
                        Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ / Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯
                    </button>
                </div>
            `;
        }

        function initMemoryPage() {
             initMemoryGame();
        }

        function initMemoryGame() {
            clearInterval(memoryGameData.timer);
            
            // 8 Ø¬ÙØª Ø§Ù…ÙˆØ¬ÛŒ
            const emojis = shuffleArray(['ğŸ', 'ğŸŠ', 'ğŸ‡', 'ğŸ‰', 'ğŸ“', 'ğŸ’', 'ğŸ¥', 'ğŸ', 'ğŸŒ', 'ğŸ‹']).slice(0, (memoryGameData.gridSize * memoryGameData.gridSize) / 2);
            const cardValues = shuffleArray([...emojis, ...emojis]);
            
            memoryGameData = {
                cards: cardValues.map((value, index) => ({ id: index, value: value, isFlipped: false, isMatched: false })),
                gridSize: 4, 
                flippedCards: [],
                matchedPairs: 0,
                canFlip: true,
                timer: null,
                timeElapsed: 0,
                moves: 0
            };

            const gridElement = document.getElementById('memory-grid');
            gridElement.innerHTML = '';
            gridElement.style.gridTemplateColumns = `repeat(${memoryGameData.gridSize}, 1fr)`;
            document.getElementById('memory-result').classList.add('hidden');
            document.getElementById('memory-moves').textContent = '0';
            document.getElementById('memory-timer').textContent = '0';
            
            memoryGameData.cards.forEach(card => {
                const btn = document.createElement('button');
                btn.id = `card-${card.id}`;
                btn.className = 'bg-primary-purple w-full aspect-square text-3xl md:text-5xl rounded-lg font-bold transition duration-300 transform hover:scale-[1.05] shadow-md';
                btn.textContent = 'â“';
                btn.onclick = () => flipCard(card.id);
                gridElement.appendChild(btn);
            });
            
            // Ø´Ø±ÙˆØ¹ ØªØ§ÛŒÙ…Ø±
            memoryGameData.timer = setInterval(() => {
                memoryGameData.timeElapsed++;
                document.getElementById('memory-timer').textContent = memoryGameData.timeElapsed;
            }, 1000);
        }

        function flipCard(id) {
            if (!memoryGameData.canFlip) return;
            const card = memoryGameData.cards.find(c => c.id === id);
            
            if (card.isFlipped || card.isMatched) return;

            card.isFlipped = true;
            memoryGameData.flippedCards.push(card);
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
            const btn = document.getElementById(`card-${card.id}`);
            btn.textContent = card.value;
            btn.classList.add('bg-white/10', 'text-white');
            btn.classList.remove('bg-primary-purple');
            
            if (memoryGameData.flippedCards.length === 2) {
                memoryGameData.moves++;
                document.getElementById('memory-moves').textContent = memoryGameData.moves;
                memoryGameData.canFlip = false; // Ù‚ÙÙ„ Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡

                const [card1, card2] = memoryGameData.flippedCards;
                
                if (card1.value === card2.value) {
                    // Match Found
                    card1.isMatched = true;
                    card2.isMatched = true;
                    memoryGameData.matchedPairs++;
                    
                    document.getElementById(`card-${card1.id}`).classList.add('bg-green-500/50', 'text-green-300');
                    document.getElementById(`card-${card2.id}`).classList.add('bg-green-500/50', 'text-green-300');

                    memoryGameData.flippedCards = [];
                    memoryGameData.canFlip = true;
                    
                    if (memoryGameData.matchedPairs === (memoryGameData.gridSize * memoryGameData.gridSize) / 2) {
                        endMemoryGame(true);
                    }
                    
                } else {
                    // No Match - Flip back after delay
                    setTimeout(() => {
                        card1.isFlipped = false;
                        card2.isFlipped = false;
                        
                        document.getElementById(`card-${card1.id}`).textContent = 'â“';
                        document.getElementById(`card-${card1.id}`).classList.add('bg-primary-purple');
                        document.getElementById(`card-${card1.id}`).classList.remove('bg-white/10', 'text-white');

                        document.getElementById(`card-${card2.id}`).textContent = 'â“';
                        document.getElementById(`card-${card2.id}`).classList.add('bg-primary-purple');
                        document.getElementById(`card-${card2.id}`).classList.remove('bg-white/10', 'text-white');

                        memoryGameData.flippedCards = [];
                        memoryGameData.canFlip = true;
                    }, 800);
                }
            }
        }

        function endMemoryGame(isWin) {
            clearInterval(memoryGameData.timer);
            const gamePoints = CONTENT.games.find(g => g.key === 'memory').points;

            if (isWin) {
                // Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ùˆ Ø­Ø±Ú©Øª (Ù…Ø«Ù„Ø§Ù‹ Ù‡Ø± 10 Ø«Ø§Ù†ÛŒÙ‡/10 Ø­Ø±Ú©Øª Ú©Ù…ØªØ±ØŒ ÛŒÚ© Ø§Ù…ØªÛŒØ§Ø² Ø¨ÛŒØ´ØªØ±)
                let bonus = Math.max(0, 100 - memoryGameData.timeElapsed - memoryGameData.moves);
                let finalScore = gamePoints + Math.floor(bonus / 20);
                
                addScore(finalScore, 'memoryGamesWon');
                showConfetti();
                
                document.getElementById('memory-result').textContent = `ØªØ¨Ø±ÛŒÚ©! Ø´Ù…Ø§ Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯ÛŒØ¯ Ùˆ +${finalScore} Ø§Ù…ØªÛŒØ§Ø² Ú¯Ø±ÙØªÛŒØ¯.`;
                document.getElementById('memory-result').classList.remove('hidden');
            } else {
                document.getElementById('memory-result').textContent = `Ø¨Ø§Ø²ÛŒ Ù†Ø§ØªÙ…Ø§Ù… Ù…Ø§Ù†Ø¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.`;
                document.getElementById('memory-result').classList.remove('hidden');
            }
        }
        
        // ************* SHOP PAGE *************
        function renderShop() {
             return `
                ${renderHeader('ğŸ›’ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Power-up Ùˆ Ø¬ÙˆØ§ÛŒØ²', true)}
                
                <p class="text-gray-300 mb-6">Ø¨Ø§ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ø®ÙˆØ¯ØŒ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡ Ù…Ø§Ù†Ù†Ø¯ Ø¨Ù„ÛŒØ·â€ŒÙ‡Ø§ÛŒ ØªØ³ØªØŒ Power-up Ù‡Ø§ Ùˆ Ø¢ÙˆØ§ØªØ§Ø±Ù‡Ø§ Ø±Ø§ Ø¨Ø®Ø±ÛŒØ¯.</p>

                <div class="glassmorphism p-5 mb-6 flex justify-around items-center rounded-lg">
                    <span class="text-xl md:text-2xl font-bold">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§:</span>
                    <span class="text-3xl md:text-4xl font-extrabold text-coin-gold">ğŸ’° ${state.score.toLocaleString()}</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${CONTENT.shopItems.map(item => {
                        const canAfford = state.score >= item.cost;
                        const buttonText = canAfford ? 'Ø®Ø±ÛŒØ¯' : 'Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª';
                        const bgColor = canAfford ? 'bg-green-500/90 hover:bg-green-600' : 'bg-gray-700/50 cursor-not-allowed';

                        // Ù†Ù…Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯ Power-up ÛŒØ§ Ø¨Ù„ÛŒØ· ÙØ¹Ù„ÛŒ
                        let statusText = '';
                        if (item.type === 'powerup') {
                            statusText = `Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${state.powerups[item.target] || 0}`;
                        } else if (item.type === 'ticket') {
                            statusText = `Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${state.testTickets[item.target] || 0}`;
                        } else if (item.type === 'rank' && state.rankBoosted) {
                            statusText = 'Ø¨ÙˆØ³Øª ÙØ¹Ø§Ù„ Ø§Ø³Øª!';
                        }
                        
                        return `
                            <div class="quiz-card p-5 rounded-xl border-l-4 ${canAfford ? 'border-coin-gold' : 'border-gray-500'} shadow-xl">
                                <h3 class="text-2xl font-bold mb-2 text-coin-gold">${item.icon} ${item.title}</h3>
                                <p class="text-md text-gray-200 mb-3">${item.desc}</p>
                                <p class="text-sm text-gray-400 font-bold mb-4">${statusText}</p>
                                <p class="text-xl font-bold mb-4 text-pink-300">Ù‚ÛŒÙ…Øª: ${item.cost} ğŸ’°</p>
                                
                                <button onclick="${canAfford ? `buyItem('${item.id}', ${item.cost})` : `showModal('Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!', 'error')`}"
                                        class="w-full p-3 rounded-lg font-bold transition ${bgColor}" ${!canAfford ? 'disabled' : ''}>
                                    ${buttonText}
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function buyItem(itemId, cost) {
             if (!subtractScore(cost)) {
                 return showModal('âŒ Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø§ÛŒÙ† Ø¢ÛŒØªÙ… Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.', 'error');
             }
             
             const item = CONTENT.shopItems.find(i => i.id === itemId);
             if (!item) return;

             let message = `âœ… Ø¢ÛŒØªÙ… ${item.title} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯.`;

             switch (item.type) {
                 case 'ticket':
                     state.testTickets[item.target] = (state.testTickets[item.target] || 0) + 1;
                     message += ` (Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯: ${state.testTickets[item.target]})`;
                     break;
                 case 'powerup':
                     state.powerups[item.target] = (state.powerups[item.target] || 0) + 1;
                     message += ` (Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯: ${state.powerups[item.target]})`;
                     break;
                 case 'rank':
                     // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¨ÙˆØ³Øª Ù…Ù‚Ø§Ù… Ø¨Ø±Ø§ÛŒ 7 Ø±ÙˆØ²
                     state.rankBoosted = new Date().toDateString();
                     updateRank();
                     message = `ğŸ‘‘ ØªØ¨Ø±ÛŒÚ©! Ù…Ù‚Ø§Ù… Ø´Ù…Ø§ Ø¨Ù‡ Ù…Ø¯Øª Û· Ø±ÙˆØ² Ø§Ø±ØªÙ‚Ø§Ø¡ ÛŒØ§ÙØª. Ù…Ù‚Ø§Ù… Ø¬Ø¯ÛŒØ¯: ${state.rank}`;
                     break;
                 case 'avatar':
                     state.userAvatar = item.target; // Ø§Ø¹Ù…Ø§Ù„ Ø¢ÙˆØ§ØªØ§Ø± Ø¬Ø¯ÛŒØ¯
                     message = `ğŸŒŸ Ø¢ÙˆØ§ØªØ§Ø± Ø´Ù…Ø§ Ø¨Ù‡ ${item.target} ØªØºÛŒÛŒØ± ÛŒØ§ÙØª.`;
                     break;
             }
             
             saveState();
             showModal(message, 'success');
             route('shop', false); // Ø±ÙØ±Ø´ ØµÙØ­Ù‡
        }

        // ************* PROFILE PAGE *************
        function renderProfile() {
            const currentRank = CONTENT.ranks.find(r => r.name === state.rank);
            const nextRankIndex = CONTENT.ranks.findIndex(r => r.name === state.rank) + (state.rankBoosted ? 2 : 1);
            const nextRank = CONTENT.ranks[nextRankIndex] || null;
            const progressPercent = nextRank ? Math.min(100, ((state.score - currentRank.scoreMin) / (nextRank.scoreMin - currentRank.scoreMin)) * 100) : 100;
            const streakText = state.streak === 0 ? 'Ù‡Ù†ÙˆØ² Ø´Ø±ÙˆØ¹ Ù†Ø´Ø¯Ù‡' : `${state.streak} Ø±ÙˆØ² Ù…ØªÙˆØ§Ù„ÛŒ`;

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Power-up Ù‡Ø§
            const totalPowerups = Object.values(state.powerups).reduce((sum, count) => sum + count, 0);

             return `
                ${renderHeader('Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†', false)}
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 glassmorphism p-8 text-center border-l-4 border-primary-purple shadow-2xl">
                        <div class="text-8xl mb-4">${state.userAvatar}</div>
                        <h2 class="text-3xl font-bold text-yellow-300 mb-2">${state.user?.username || 'Ú©Ø§Ø±Ø¨Ø± ÙØ§Ù† Ø¨Ø§Ø²'}</h2>
                        <p class="text-md text-gray-400 mb-4">${state.user?.email || 'Ø¨Ø¯ÙˆÙ† Ø§ÛŒÙ…ÛŒÙ„'}</p>
                        
                        <div class="my-4">
                            <h3 class="text-2xl font-extrabold ${currentRank.color}">${state.rank} - Ø³Ø·Ø­ ${state.level}</h3>
                            <p class="text-lg font-bold text-coin-gold">ğŸ’° Ø§Ù…ØªÛŒØ§Ø²: ${state.score.toLocaleString()}</p>
                        </div>
                        
                        <button onclick="route('edit-profile')" class="mt-4 w-full px-6 py-3 bg-primary-pink rounded-lg hover:bg-primary-purple transition font-bold">
                            ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                        </button>
                         <button onclick="logout()" class="mt-2 w-full px-6 py-3 bg-red-600/80 rounded-lg hover:bg-red-700 transition font-bold">
                            Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨
                        </button>
                    </div>

                    <div class="lg:col-span-2 space-y-6">
                        <div class="glassmorphism p-6 border-l-4 border-rank-gold">
                            <h3 class="text-2xl font-bold mb-3 text-rank-gold">ğŸš€ Ù¾ÛŒØ´Ø±ÙØª Ù…Ù‚Ø§Ù…</h3>
                            ${nextRank ? `
                                <p class="mb-2 text-gray-300">Ø¨Ø±Ø§ÛŒ Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ù…Ù‚Ø§Ù… **${nextRank.name}** Ø¨Ù‡ ${nextRank.scoreMin - state.score} Ø§Ù…ØªÛŒØ§Ø² Ø¯ÛŒÚ¯Ø± Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯.</p>
                                <div class="w-full bg-white/20 rounded-full h-3">
                                    <div class="bg-rank-gold h-3 rounded-full transition-all duration-500" style="width: ${progressPercent}%"></div>
                                </div>
                                <p class="mt-2 text-sm text-gray-400 text-left">${progressPercent.toFixed(1)}%</p>
                            ` : `
                                <p class="text-green-400 font-bold">Ø´Ù…Ø§ Ø¯Ø± Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ù…Ù‚Ø§Ù… Ù‡Ø³ØªÛŒØ¯! (Ù„Ø§ÛŒØªâ€ŒØ¨Ø§Ø²)</p>
                            `}
                            ${state.rankBoosted ? `<p class="mt-3 text-sm text-pink-400 font-bold">ğŸ‘‘ Ø¨ÙˆØ³Øª Ù…Ù‚Ø§Ù… ÙØ¹Ø§Ù„ Ø§Ø³Øª!</p>` : ''}
                        </div>
                        
                        <div class="glassmorphism p-6 border-l-4 border-blue-400">
                             <h3 class="text-2xl font-bold mb-3 text-blue-400">ğŸ“Š Ø¢Ù…Ø§Ø± ÙØ¹Ø§Ù„ÛŒØª</h3>
                             <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div class="bg-white/10 p-3 rounded-lg"><span class="block text-2xl font-bold">${state.riddlesSolved}</span> <span class="text-sm text-gray-400">Ù…Ø¹Ù…Ø§ÛŒ Ø­Ù„ Ø´Ø¯Ù‡</span></div>
                                <div class="bg-white/10 p-3 rounded-lg"><span class="block text-2xl font-bold">${state.totalTestsCompleted}</span> <span class="text-sm text-gray-400">ØªØ³Øª Ú©Ø§Ù…Ù„ Ø´Ø¯Ù‡</span></div>
                                <div class="bg-white/10 p-3 rounded-lg"><span class="block text-2xl font-bold">${state.gamesWon + state.memoryGamesWon}</span> <span class="text-sm text-gray-400">Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø¯Ù‡</span></div>
                                <div class="bg-white/10 p-3 rounded-lg"><span class="block text-2xl font-bold text-green-400">${streakText}</span> <span class="text-sm text-gray-400">Ø§Ø³ØªØ±ÛŒÚ©</span></div>
                             </div>
                        </div>

                        <div class="glassmorphism p-6 border-l-4 border-purple-400 flex justify-between items-center">
                            <div>
                                <h3 class="text-2xl font-bold mb-1 text-purple-400">âœ¨ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Power-up</h3>
                                <p class="text-gray-300">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Power-up Ù‡Ø§ÛŒ Ø´Ù…Ø§: ${totalPowerups}</p>
                            </div>
                            <button onclick="route('shop')" class="px-6 py-2 bg-purple-500 rounded-lg hover:bg-purple-600 transition font-bold">
                                Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ************* EDIT PROFILE PAGE *************
        function renderEditProfile() {
            return `
                ${renderHeader('ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„', true)}
                
                <div class="glassmorphism p-6 md:p-8 max-w-lg mx-auto border-l-4 border-pink-400">
                    <form id="edit-profile-form" onsubmit="saveProfileChanges(event)" class="space-y-6">
                        
                        <div class="text-center">
                            <label class="text-xl font-bold block mb-2">Ø§Ù†ØªØ®Ø§Ø¨ Ø¢ÙˆØ§ØªØ§Ø±</label>
                            <div class="flex justify-center flex-wrap gap-4">
                                ${CONTENT.avatars.map(avatar => `
                                    <label class="cursor-pointer">
                                        <input type="radio" name="avatar" value="${avatar}" ${state.userAvatar === avatar ? 'checked' : ''} class="hidden" onchange="document.getElementById('selected-avatar').textContent = this.value">
                                        <span class="text-5xl p-2 rounded-full transition-all duration-200 ${state.userAvatar === avatar ? 'bg-primary-pink border-4 border-white' : 'hover:bg-white/10'}">${avatar}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <label for="edit-username" class="text-gray-300 block mb-2">Ù†Ø§Ù… Ù…Ø³ØªØ¹Ø§Ø±</label>
                            <input type="text" id="edit-username" value="${state.user?.username || ''}" required 
                                class="w-full p-3 rounded-lg bg-white/10 border border-white/30 focus:outline-none focus:ring-2 focus:ring-pink-500" />
                        </div>
                        
                        <div class="text-center mt-4">
                            <span class="text-8xl" id="selected-avatar">${state.userAvatar}</span>
                        </div>
                        
                        <button type="submit" class="w-full p-3 rounded-lg font-bold text-lg transition-all duration-300 transform hover:scale-[1.02]
                          bg-gradient-to-r from-primary-purple to-pink-500 shadow-lg">
                          Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
                        </button>
                    </form>
                </div>
            `;
        }
        
        function saveProfileChanges(e) {
             e.preventDefault();
             const newUsername = document.getElementById('edit-username').value.trim();
             const newAvatar = document.querySelector('input[name="avatar"]:checked').value;

             if (state.user) {
                 state.user.username = newUsername;
             }
             state.userAvatar = newAvatar;

             showModal('âœ… ØªØºÛŒÛŒØ±Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.', 'success');
             updateLeaderboard(newUsername, state.score, state.rank);
             saveState();
             route('profile', false);
        }
        
        function logout() {
             state = {
                user: null, 
                isAuthenticated: false,
                score: 0,
                level: 1,
                rank: 'Ù…Ø¨ØªØ¯ÛŒ', 
                streak: 0,
                riddlesSolved: 0,
                testsCompleted: { mbti: 0, color: 0, memory: 0 }, 
                testTickets: { mbti: 1, color: 1, memory: 1 }, 
                gamesWon: 0, 
                memoryGamesWon: 0, 
                dailyPlayed: new Date('1/1/2000').toDateString(), 
                lastPlayedDate: new Date('1/1/2000').toDateString(),
                theme: state.theme, // Ø­ÙØ¸ ØªÙ…
                badges: {}, 
                solvedRiddles: {}, 
                riddleChoices: {},
                userAvatar: 'ğŸ‘¤',
                powerups: { doubleScore: 0, freeHint: 0 }, 
                rankBoosted: null, 
                leaderboard: state.leaderboard.filter(u => u.username !== state.user?.username), // Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù„ÛŒØ¯Ø±Ø¨Ø±Ø¯
                totalTestsCompleted: 0, 
             };
             localStorage.removeItem('funbaz_state');
             historyStack = [];
             showModal('ğŸ‘‹ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø² Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.', 'info');
             route('login');
        }

        // ************* LEADERBOARD PAGE *************
        function renderLeaderboard() {
            const sortedLeaderboard = [...state.leaderboard].sort((a, b) => b.score - a.score);

            return `
                ${renderHeader('ğŸ† Ø¬Ø¯ÙˆÙ„ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¬Ù‡Ø§Ù†ÛŒ', true)}
                
                <p class="text-gray-300 mb-6">Ø¨Ø±ØªØ±ÛŒÙ† Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ø§Ø² Ù†Ø¸Ø± Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ÛŒ Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</p>
                
                <div class="glassmorphism p-6 md:p-8 border-l-4 border-rank-gold">
                    <table class="min-w-full text-right divide-y divide-white/20">
                        <thead>
                            <tr>
                                <th class="py-3 px-2 md:px-6 text-sm font-bold text-gray-300 tracking-wider">Ø±ØªØ¨Ù‡</th>
                                <th class="py-3 px-2 md:px-6 text-sm font-bold text-gray-300 tracking-wider">Ù†Ø§Ù… Ù…Ø³ØªØ¹Ø§Ø±</th>
                                <th class="py-3 px-2 md:px-6 text-sm font-bold text-gray-300 tracking-wider">Ù…Ù‚Ø§Ù…</th>
                                <th class="py-3 px-2 md:px-6 text-sm font-bold text-gray-300 tracking-wider">Ø§Ù…ØªÛŒØ§Ø²</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/10">
                            ${sortedLeaderboard.map((user, index) => {
                                let rankIcon = '';
                                let rankColor = 'text-white';
                                if (index === 0) { rankIcon = 'ğŸ¥‡'; rankColor = 'text-rank-gold'; }
                                else if (index === 1) { rankIcon = 'ğŸ¥ˆ'; rankColor = 'text-rank-silver'; }
                                else if (index === 2) { rankIcon = 'ğŸ¥‰'; rankColor = 'text-rank-bronze'; }
                                
                                const isCurrentUser = state.isAuthenticated && state.user?.username === user.username;
                                
                                return `
                                    <tr class="${isCurrentUser ? 'bg-primary-purple/50 font-bold' : 'hover:bg-white/10 transition'}">
                                        <td class="py-4 px-2 md:px-6 whitespace-nowrap text-lg ${rankColor}">${rankIcon || (index + 1)}</td>
                                        <td class="py-4 px-2 md:px-6 whitespace-nowrap">${user.username} ${isCurrentUser ? '(Ø´Ù…Ø§)' : ''}</td>
                                        <td class="py-4 px-2 md:px-6 whitespace-nowrap">${user.rank}</td>
                                        <td class="py-4 px-2 md:px-6 whitespace-nowrap text-coin-gold font-bold">${user.score.toLocaleString()}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ************* AWARDS PAGE *************
        function renderAwards() {
             return `
                ${renderHeader('ğŸ… Ø¬ÙˆØ§ÛŒØ² Ùˆ Ù…Ø¯Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ú©Ø³Ø¨ Ø´Ø¯Ù‡', true)}
                
                <p class="text-gray-300 mb-6">Ø§ÛŒÙ† Ù…Ø¯Ø§Ù„â€ŒÙ‡Ø§ Ù†Ø´Ø§Ù†â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ Ø´Ù…Ø§ Ø¯Ø± ÙØ§Ù† Ø¨Ø§Ø² Ù‡Ø³ØªÙ†Ø¯.</p>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${CONTENT.badges.map(badge => {
                        const isAchieved = state.badges[badge.id];
                        let progress = 0;
                        
                        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾ÛŒØ´Ø±ÙØª
                        let current = 0;
                        if (badge.field === 'totalTestsCompleted') { current = state.totalTestsCompleted; }
                        else if (badge.field === 'memoryGamesWon') { current = state.memoryGamesWon; }
                        else if (badge.field === 'gamesWon') { current = state.gamesWon; }
                        else { current = state[badge.field] || 0; }

                        progress = Math.min(100, (current / badge.goal) * 100);
                        
                        let badgeColor = '';
                        if (badge.type === 'Ø·Ù„Ø§') badgeColor = 'border-rank-gold text-rank-gold';
                        else if (badge.type === 'Ù†Ù‚Ø±Ù‡') badgeColor = 'border-rank-silver text-rank-silver';
                        else badgeColor = 'border-rank-bronze text-rank-bronze';
                        
                        return `
                            <div class="glassmorphism p-5 rounded-xl border-l-4 ${isAchieved ? badgeColor : 'border-gray-500'} shadow-xl">
                                <div class="flex items-center mb-3">
                                    <span class="text-5xl ml-3">${badge.icon}</span>
                                    <div>
                                        <h3 class="text-xl font-bold ${isAchieved ? badgeColor : 'text-gray-300'}">${badge.title} ${isAchieved ? 'âœ…' : ''}</h3>
                                        <p class="text-sm text-gray-400">Ù†ÙˆØ¹: ${badge.type}</p>
                                    </div>
                                </div>
                                <p class="text-md text-gray-200 mb-3">${badge.cond}</p>
                                
                                <div class="mt-4">
                                    <p class="text-sm text-gray-400 mb-1">Ù¾ÛŒØ´Ø±ÙØª: ${current}/${badge.goal}</p>
                                    <div class="w-full bg-white/20 rounded-full h-2">
                                        <div class="h-2 rounded-full transition-all duration-500" 
                                             style="width: ${progress}%; background-color: ${isAchieved ? (badge.type === 'Ø·Ù„Ø§' ? '#ffd700' : (badge.type === 'Ù†Ù‚Ø±Ù‡' ? '#c0c0c0' : '#cd7f32')) : '#4b5563'};">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // --- 7. AUTHENTICATION & INITIAL SETUP ---
        
        function initAuthPage() {
             // 1. Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ØªÙ†Ø¸ÛŒÙ… Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø± UI (ÙˆØ±ÙˆØ¯)
             toggleAuthMode(false); 
             
             // 2. Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª
             const toggleButton = document.getElementById('toggle-mode');
             if (toggleButton) {
                 toggleButton.onclick = () => toggleAuthMode(true);
             }
             
             // 3. Ø§ØªØµØ§Ù„ ÙØ±Ù… Ø§ØµÙ„ÛŒ
             document.getElementById('auth-form').onsubmit = (e) => {
                 e.preventDefault();
                 const usernameInput = document.getElementById('username');
                 const email = document.getElementById('email').value.trim();
                 const password = document.getElementById('password').value.trim();
                 // Ú†Ú© Ú©Ø±Ø¯Ù† Ù†Ù‡Ø§ÛŒÛŒ ÙˆØ¶Ø¹ÛŒØª: Ø¢ÛŒØ§ ÙÛŒÙ„Ø¯ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù¾Ù†Ù‡Ø§Ù† Ø§Ø³ØªØŸ (Ø§Ú¯Ø± Ù¾Ù†Ù‡Ø§Ù† Ù†Ø¨Ø§Ø´Ø¯ØŒ Ø«Ø¨Øª Ù†Ø§Ù… Ø§Ø³Øª)
                 const isRegistering = !usernameInput.classList.contains('hidden'); 
                 const authError = document.getElementById('auth-error');
                 authError.textContent = '';
                 
                 // --- Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ÙØ±Ø§ÛŒÙ†Ø¯ Ø«Ø¨Øª Ù†Ø§Ù… ---
                 if (isRegistering) {
                     const username = usernameInput.value.trim();
                     if (username.length < 3 || password.length < 6) {
                         authError.textContent = 'Ù†Ø§Ù… Ù…Ø³ØªØ¹Ø§Ø± Ø­Ø¯Ø§Ù‚Ù„ Û³ Ú©Ø§Ø±Ø§Ú©ØªØ± Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø­Ø¯Ø§Ù‚Ù„ Û¶ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.';
                         return;
                     }
                     // ØªÙ†Ø¸ÛŒÙ… ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                     state.isAuthenticated = true;
                     state.user = { username, email, id: Date.now().toString() };
                     state.score = 0; 
                     state.level = 1;
                     state.testTickets = { mbti: 1, color: 1, memory: 1 };
                     state.userAvatar = 'ğŸ‘¤';
                     
                     saveState();
                     showConfetti();
                     showModal(`ğŸ‰ Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ²! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${username}`, 'success');
                     
                     // **ØªØ¶Ù…ÛŒÙ† Ø±ÛŒØ¯Ø§ÛŒØ±Ú©Øª Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø¹Ø¯ Ø§Ø² Ø«Ø¨Øª Ù†Ø§Ù…**
                     route('dashboard'); 
                     
                 // --- Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ÙØ±Ø§ÛŒÙ†Ø¯ ÙˆØ±ÙˆØ¯ ---
                 } else {
                      if (!email || !password) {
                         authError.textContent = 'Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.';
                         return;
                      }
                      
                      // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª (Ø§Ú¯Ø± Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± Ø§Ø³Øª)
                      state.isAuthenticated = true;
                      if (!state.user) {
                           state.user = { username: email.split('@')[0], email, id: '123' };
                           state.score = 100; 
                           state.userAvatar = 'ğŸ¤–';
                      }

                      saveState();
                      showModal(`ğŸ‘‹ ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ². Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${state.user.username}`, 'success');
                      route('dashboard');
                 }
                 
             };
        }
        
        /**
         * ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ† ÙˆØ±ÙˆØ¯ Ùˆ Ø«Ø¨Øª Ù†Ø§Ù…
         * @param {boolean} toggleUI - Ø¢ÛŒØ§ UI Ø¨Ø§ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ (Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØºÛŒÛŒØ± Ù‡Ù†Ú¯Ø§Ù… Ù„ÙˆØ¯ Ø§ÙˆÙ„ÛŒÙ‡)
         */
        function toggleAuthMode(toggleUI = true) {
            const usernameInput = document.getElementById('username');
            const toggleButton = document.getElementById('toggle-mode');
            const submitButton = document.getElementById('auth-submit-btn');
            
            if (!usernameInput || !toggleButton || !submitButton) return;

            // ØªØ´Ø®ÛŒØµ Ø­Ø§Ù„Øª ÙØ¹Ù„ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ visibility Ù†Ø§Ù… Ù…Ø³ØªØ¹Ø§Ø±
            const isRegistering = !usernameInput.classList.contains('hidden');

            if (toggleUI) {
                 if (isRegistering) {
                    // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ÙˆØ±ÙˆØ¯
                    usernameInput.classList.add('hidden');
                    toggleButton.textContent = 'Ø­Ø³Ø§Ø¨ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯';
                    submitButton.textContent = 'ÙˆØ±ÙˆØ¯';
                 } else {
                    // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø«Ø¨Øª Ù†Ø§Ù…
                    usernameInput.classList.remove('hidden');
                    toggleButton.textContent = 'Ù‚Ø¨Ù„Ø§Ù‹ Ø­Ø³Ø§Ø¨ Ø¯Ø§Ø´ØªÙ…. ÙˆØ±ÙˆØ¯';
                    submitButton.textContent = 'Ø«Ø¨Øª Ù†Ø§Ù…';
                 }
            } else {
                 // ØªÙ†Ø¸ÛŒÙ… Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡: ÙˆØ±ÙˆØ¯ (Username Ù¾Ù†Ù‡Ø§Ù†)
                 usernameInput.classList.add('hidden');
                 toggleButton.textContent = 'Ø­Ø³Ø§Ø¨ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯';
                 submitButton.textContent = 'ÙˆØ±ÙˆØ¯';
            }
        }
        
        // --- 8. GLOBAL INIT & EVENT LISTENERS ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // Ø§Ø¹Ù…Ø§Ù„ ØªÙ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
            if (state.theme === 'light') {
                document.documentElement.classList.remove('dark');
                document.documentElement.classList.add('light');
                document.getElementById('theme-toggle').textContent = 'ğŸŒ™';
            } else {
                 document.documentElement.classList.remove('light');
                 document.documentElement.classList.add('dark');
                 document.getElementById('theme-toggle').textContent = 'â˜€ï¸';
            }
            
            // ØªØ¹ÛŒÛŒÙ† ØµÙØ­Ù‡ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Hash ÛŒØ§ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
            let initialPage = window.location.hash.substring(1) || 'dashboard';
            if (!state.isAuthenticated && initialPage !== 'login') {
                initialPage = 'login';
            }
            
            // Ø­Ù„ Ù…Ø´Ú©Ù„: Ø§Ú¯Ø± Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ù‡ ØµÙØ­Ù‡ Ù„Ø§Ú¯ÛŒÙ† Ø±ÙØª Ùˆ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø­Ø±Ø§Ø² Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø±ÛŒØ¯Ø§ÛŒØ±Ú©Øª Ú©Ù†
            if (state.isAuthenticated && initialPage === 'login') {
                 initialPage = 'dashboard';
            }

            // Ø±Ù†Ø¯Ø± Ø§ÙˆÙ„ÛŒÙ‡
            route(initialPage, false);
            initialLoader.style.display = 'none';

            // Ù…Ø§Ù†ÛŒØªÙˆØ± Ú©Ø±Ø¯Ù† ØªØºÛŒÛŒØ±Ø§Øª Hash (Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Forward/Backward Ù…Ø±ÙˆØ±Ú¯Ø±)
            window.addEventListener('hashchange', (e) => {
                 const newPage = window.location.hash.substring(1);
                 // Ø§ÛŒÙ† Ø¨Ø§Ø¹Ø« Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ú©Ù‡ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø± Ù‡Ù… Ú©Ø§Ø± Ú©Ù†Ù†Ø¯ØŒ Ø§Ù…Ø§ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§ `historyStack` ØªØ¯Ø§Ø®Ù„ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
                 // Ø¨Ø±Ø§ÛŒ Ø­Ù„ Ø§ÛŒÙ† Ù…Ø´Ú©Ù„ØŒ `historyStack` ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ `goBack` Ø¯Ø§Ø®Ù„ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                 renderPage(newPage);
            });
            
            // Ú†Ú© Ú©Ø±Ø¯Ù† Ø§Ø³ØªØ±ÛŒÚ© Ø±ÙˆØ²Ø§Ù†Ù‡ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø§ÛŒØª (Ø§Ú¯Ø± Ø§Ø­Ø±Ø§Ø² Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
            if (state.isAuthenticated) {
                const today = new Date().toDateString();
                // Ø§Ú¯Ø± Ø§Ù…Ø±ÙˆØ² Ú†Ø§Ù„Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø±Ø§ Ø¨Ø§Ø²ÛŒ Ù†Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯ÛŒØ±ÙˆØ² Ø¨Ø§Ø²ÛŒ Ú©Ø±Ø¯Ù‡ØŒ Ø§Ø³ØªØ±ÛŒÚ© Ø±Ø§ Ú†Ú© Ú©Ù†
                if (state.dailyPlayed !== today) {
                     // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø­ÙØ¸ Ø§Ø³ØªØ±ÛŒÚ©ØŒ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ Ú©Ø±Ø¯Ù† Ù†ÛŒØ³ØªØŒ ÙÙ‚Ø· Ø¨Ø§ÛŒØ¯ Ø¯ÛŒØ±ÙˆØ² Ø¨Ø§Ø²ÛŒ Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
                     updateStreak();
                }
            }
        });

    </script>
</body>
</html>